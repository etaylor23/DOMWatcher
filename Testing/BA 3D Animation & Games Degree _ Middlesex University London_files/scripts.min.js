/*
 *     Middlesex Video Wall - JavaScript - main
 *     @author Jacek Skwarna (Squiz)
 *     -----------------------------------------------
 *
 *
 *     1. Functions.
 *       1.1 Video Wall control
 */

/*
 --------------------
 1. Functions
 --------------------
 */

/* -- 1.1 Video Wall control -- */
var videoWall = {
    api: null,

    featured_video_width: 450,
    featured_video_height: 253,
    corrupted_embeded_video_message: "This video file is corrupted. Please choose another one.",

    setApi: function () {
        this.api = flowplayer();
    },

    setBackground: function () {
        if (typeof GlobalVars.url.featured_video) {
            jQuery('.featured-video .flowplayer').css({'background-image': 'url(' + GlobalVars.url.featured_video + ')', 'background-repeat': 'no-repeat', 'background-size': '100%'});
        }
    },

    createEmbededVideoIframe: function video(e) {
        var url = e.attr('href');
        if ('' === url || !url) {
            if (jQuery('.featured-video .alert').length) {
                jQuery('.featured-video .alert').text(videoWall.corrupted_embeded_video_message);
            }
            else {
                jQuery('.featured-video').prepend('<p class="alert">' + videoWall.corrupted_embeded_video_message + '</p>');
            }
            return;
        }

        var html = '<iframe class="iframe-video" src="'+url+'" width="'+videoWall.featured_video_width+'" height="'+videoWall.featured_video_height+'" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>';
        e.remove();
        if (jQuery('.featured-video iframe.iframe-video').length) {
            jQuery('.featured-video iframe.iframe-video').attr('src', url);
        }
        else {
            jQuery('.featured-video .alert').remove();
            jQuery('.featured-video .flowplayer').hide();
            jQuery('.featured-video').prepend(html);
        }

        //e.before('<p class="text-center" style="padding:15px 0 0;">'+html+'</p>');
        //e.remove();
    },

    reloadVideoHandler: function () {
        var tmp_api = flowplayer();
        jQuery(document).on('click', '.video-wall > li > a', function(e){
            e.preventDefault();
            var vid = jQuery(this).data('vid'),
                tmp_video_type = '',
                tmp_name = null,
                tmp_video_url = null,
                tmp_description = null,
                tmp_pdf = null,
                tmp_pdf_name = 'download pdf',
                tmp_video_extension = null,
                tmp_file_size = 0,
                tmp_thumbnail = null;

            jQuery('html, body').animate({
                scrollTop: jQuery('body').offset().top
            }, 200);

            jQuery.ajax({
                type: "GET",
                url: GlobalVars.url.load_video_new + '?vid=' + vid,
                cache: false,
                dataType: "json",
                beforeSend: function(){
                    jQuery('.featured-video .flowplayer .ajax-loader').fadeIn();
                    tmp_api.stop();
                },
                success: function (data){
                    if (typeof data['video'] && data['video'].length > 0) {
                        tmp_video_type = data['video'][0]['type'] || '',
                        tmp_name = data['video'][0]['name'] || null,
                        tmp_video_url = data['video'][0]['url'] || null,
                        tmp_description = data['video'][0]['description'] || null,
                        tmp_pdf = data['video'][0]['pdf'] || null,
                        tmp_pdf_name = data['video'][0]['pdf_name'] || 'download pdf',
                        tmp_file_size = data['video'][0]['file_size'] || 0,
                        tmp_video_extension = null,
                        tmp_thumbnail = data['video'][0]['thumbnail'] || null;
                    }
                    else {
                        tmp_file_size = 0;
                    }

                },
                complete: function(xhr,status) {
                    //console.log('textStatus: ' + status);
                    if (status === 'success') {
                        jQuery('.flowplayer').first().find('.replacement').fadeOut();
                        if (tmp_thumbnail) {
                            jQuery('.flowplayer').first().css({'background-image': 'url(' + tmp_thumbnail + ')'});
                        }

                        if (tmp_name) {
                            jQuery('.featured-video h2').text(tmp_name);
                        }
                        if (tmp_description) {
                            jQuery('#featured-video-description').text(tmp_description);
                        }
                        else {
                            jQuery('#featured-video-description').text('');
                        }

                        if (tmp_pdf) {
                            if (jQuery('#featured-video-pdf').length) {
                                jQuery('#featured-video-pdf').attr('href', tmp_pdf);
                            }
                            else {
                                jQuery('.featured-video').append('<a id="featured-video-pdf" href="' + tmp_pdf + '" class="view-all">' + tmp_pdf_name + '</a>');
                            }
                            jQuery('#featured-video-pdf').attr('href', tmp_pdf);
                        }
                        else {
                            jQuery('#featured-video-pdf').remove();
                        }

                        if (tmp_video_url) {
                            if (tmp_video_type === 'youtube' || tmp_video_type === 'vimeo') {
                                jQuery('.featured-video .featured-external-video').remove();
                                jQuery('.featured-video').prepend('<a href="' + tmp_video_url + '" class="featured-external-video">' + tmp_name + '</a>');
                                videoWall.createEmbededVideoIframe(jQuery('a.featured-external-video').first());
                            }
                            else if (tmp_video_type === 'internal_video') {
                                jQuery('iframe.iframe-video').remove();
                                jQuery('.featured-video .flowplayer').show();
                                tmp_video_extension = tmp_video_url.split('.').pop();

                                switch (tmp_video_extension) {
                                    case 'mov':
                                        tmp_video_type = 'quicktime';
                                        tmp_api.unload();
                                        tmp_api.load([
                                            { mp4: tmp_video_url }
                                        ]);
                                        break;
                                    default:
                                        tmp_video_type = 'quicktime';
                                        tmp_api.unload();
                                        tmp_api.load([
                                            { mp4: tmp_video_url }
                                        ]);
                                        break;
                                }
                            }
                            else {
                            }
                        }

                        jQuery('.featured-video .flowplayer .ajax-loader').fadeOut();
                    }
                    else {
                        if (jQuery('.flowplayer').first().find('.replacement').length) {
                            jQuery('.flowplayer').first().find('.replacement').fadeIn();
                        }
                        else {
                            jQuery('.flowplayer').first().append('<p class="replacement">This video file is corrupted.</p>');
                        }
                        tmp_api.unload();
                    }
                }
            });
        });
    },

    paginationControl: function () {
        var pages_counter = jQuery('#video-wall-pagination .pagination-list > li').length,
            max_page_index = jQuery('#video-wall-pagination .pagination-list > li').length - 1,
            current_page = 0;

        jQuery(document).on('click', '#video-wall-pagination .pagination-list > li > a, #video-wall-pagination .pagination-previous, #video-wall-pagination .pagination-next', function(e){
            e.preventDefault();

            var previous_clicked = 0,
                next_clicked = 0,
                selected_page = 0;

            if (jQuery(this).parents('.pagination-list').length) {//user has clicked a page number
                selected_page = jQuery(this).parent().index();
            }
            else if (jQuery(this).hasClass('pagination-previous') && current_page > 0) {//user has clicked a previous button
                previous_clicked = 1;
            }
            else if (jQuery(this).hasClass('pagination-next') && current_page < max_page_index) {//user has clicked a previous button
                next_clicked = 1;
            }

            var target_url = jQuery(this).attr('href') || null;
            if (!target_url || target_url === '#' || target_url === '') {
                return 0;
            }
            else {
                target_url = GlobalVars.url.our_videos_new + '?' + target_url.split('?').pop();

                jQuery.ajax({
                    type: "GET",
                    url: target_url,
                    cache: false,
                    dataType: "html",
                    beforeSend: function(){
                        jQuery('#video-wall-our-videos .ajax-loader').fadeIn();
                    },
                    success: function(data) {
                        jQuery('#video-wall-our-videos ul.video-wall').html(jQuery(data).find('.video-wall').html());
                        jQuery('#video-wall-our-videos .ajax-loader').fadeOut();

                        if (previous_clicked) {
                            current_page -= 1;
                        }
                        else if (next_clicked) {
                            current_page +=1;
                        }
                        else {
                            current_page = selected_page;
                        }


                        //change selected page
                        jQuery('#video-wall-pagination .pagination-list > li').removeClass('active');
                        jQuery('#video-wall-pagination .pagination-list > li').eq(current_page).addClass('active');

                        //set first page href attribute
                        if (current_page > 0) {
                            var tmp_href = jQuery('#video-wall-pagination .pagination-list > li').eq(1).find('a').attr('href');
                            tmp_href = tmp_href.replace('result_page=2', 'result_page=1');
                            jQuery('#video-wall-pagination .pagination-list > li').eq(0).find('a').attr('href', tmp_href);
                        }
                        //set new value for previous button
                        if (current_page > 0) {
                            jQuery('#video-wall-pagination a.pagination-previous').attr('href', jQuery('#video-wall-pagination .pagination-list > li').eq(current_page - 1).find('a').attr('href'));
                        }
                        else {
                            jQuery('#video-wall-pagination a.pagination-previous').attr('href', '#');
                        }
                        //set new value for next button
                        if (current_page < max_page_index) {
                            jQuery('#video-wall-pagination a.pagination-next').attr('href', jQuery('#video-wall-pagination .pagination-list > li').eq(current_page + 1).find('a').attr('href'));
                        }
                        else {
                            jQuery('#video-wall-pagination a.pagination-next').attr('href', '#');
                        }
                    }
                });
            }
        });
    },

    init: function () {
        this.setApi();
        this.setBackground();
        this.reloadVideoHandler();
        this.paginationControl();
        if (jQuery('a.featured-external-video').length) {
            this.createEmbededVideoIframe(jQuery('a.featured-external-video').first());
        }
    }
};

/*
1. On window load
 */

jQuery(window).load(function(){

});

/*
 --------------------
 1. Document ready
 --------------------
 */

jQuery(document).ready(function(){
    //videoWall.flowplayerGlobalConfig();
    videoWall.init();
});
(function($){$.fn.fbcompletion=function(settings){var config={collection:"funnelback_documentation",show:10,sort:0,delay:0,length:3,alpha:.5,program:"/s/redirect",interactionLog:"/s/log",format:"simple",enabled:"disabled",logging:"enabled",dwellLogging:"enabled",dwellLoggingTimeout:3e3,selectLogging:"enabled",tmplId:"fb-completion-tmpl",profile:"_default",zindex:1e3};var logger=function(e,t,n,r,i){if(e&&config.logging==="enabled"){var s=config.interactionLog+"?collection="+config.collection+"&type="+encodeURIComponent(n)+"&client_time="+(new Date).getTime()+(config.profile!==""?"&profile="+config.profile:"");for(var o in r){s+="&"+encodeURIComponent(o)+"="+encodeURIComponent(r[o])}if(t){i();jQuery.ajax({type:"GET",url:s,error:function(e,t,n){if(window.console){console.log("Interaction log error: "+t+", "+n)}}})}else{jQuery.ajax({type:"GET",url:s,error:function(e,t,n){if(window.console){console.log("Interaction log error: "+t+", "+n)}i()},success:function(e){i()}})}}else{i()}};if(settings)$.extend(config,settings);if(config.enabled!="enabled"){return}this.each(function(){var targetElement=this;var dwellTimeoutCallback;var compiledTmpl;if(jQuery().template){if(jQuery("#"+config.tmplId).length>0){compiledTmpl=jQuery("#"+config.tmplId).template()}else{compiledTmpl=jQuery("<script>[Error: Template <tt>"+config.tmplId+"</tt> not found]</script>").template()}}$(targetElement).autocomplete({appendTo:$("#fb-queryform").length>0?"#fb-queryform":"body",source:function(e,t){jQuery.ajax({type:"GET",url:config.program+"?collection="+config.collection+"&partial_query="+e.term.replace(/ /g,"+")+"&show="+config.show+"&sort="+config.sort+"&alpha="+config.alpha+"&fmt="+(config.format=="simple"?"json":"json++")+(config.profile!==""?"&profile="+config.profile:""),dataType:"jsonp",error:function(e,t,n){if(window.console){console.log("Autocomplete error: "+t+", "+n)}},success:function(n){var r=new Array;for(var i=0;i<n.length;i++){var s=n[i];if(s==null){continue}if(typeof s=="string"){r.push({label:s,matchOn:e.term,rank:i+1})}else if(typeof s=="object"){r.push({label:s.disp?s.disp:s.key,value:s.action_t=="Q"?s.action:s.key,extra:s,matchOn:e.term,category:s.cat,rank:i+1})}}t(r)}})},open:function(){jQuery(this).autocomplete("widget").css("z-index",config.zindex);if(typeof dwellTimeoutCallback!=="undefined"){clearTimeout(dwellTimeoutCallback)}if(config.dwellLogging==="enabled"){dwellTimeoutCallback=setTimeout(function(e){var t=$(targetElement).val();logger(config.dwellLogging==="enabled",true,"dwell",{partial_query:t},function(){})},config.dwellLoggingTimeout)}return false},close:function(){if(typeof dwellTimeoutCallback!=="undefined"){clearTimeout(dwellTimeoutCallback)}},delay:config.delay,minLength:config.length,select:function(evt,ui){if(ui.item.extra){switch(ui.item.extra.action_t){case"C":eval(ui.item.extra.action);break;case"U":document.location=ui.item.extra.action;break;case undefined:case"":jQuery(this).val(ui.item.value);break;case"Q":default:jQuery(this).val(ui.item.extra.action)}}else{jQuery(this).val(ui.item.value.replace(" s ","'s "))}return false}}).data("ui-autocomplete")._renderItem=function(ul,item){var label;if(item.extra){switch(item.extra.disp_t){case"J":if(compiledTmpl){label=jQuery.tmpl(compiledTmpl,item.extra.disp).appendTo("<p></p>").parent().html()}else{label="[Error: jQuery template plugin is unavailable]"}break;case"C":label=eval(item.extra.disp);break;case"T":label=item.label.replace(new RegExp("("+item.matchOn+")","i"),"<strong>$1</strong>");break;case"H":default:label=item.label}}else{label=item.label.replace(new RegExp("("+item.matchOn+")","i"),"<strong>$1</strong>")}return jQuery("<li></li>").data("item.autocomplete",item).append("<a>"+label+"</a>").appendTo(ul)};$(targetElement).data("ui-autocomplete")._renderMenu=function(e,t){var n=this;var r="";jQuery.each(t,function(t,i){if(i.category&&i.category!=r){e.append('<li class="ui-autocomplete-category">'+i.category+"</li>");r=i.category}n._renderItemData(e,i)})}});return this}})(jQuery)
/*
 *     Middlesex University - JavaScript
 *     @author Tomasz Rembacz (Squiz)
 *     -----------------------------------------------
 *
 *
 *     1. Modules
 *       1.1 Announcement Bar
 *       1.2 Saved Pages
 *       1.3 Tabs
 *       1.4 Responsive Navigation
 *       1.5 Gallery Component
 *       1.6 Cookies notification
 *       1.7 Share widget
 *       1.8 Promotional sliders + lightbox
 *       1.9 Showcase lightbox
 *       1.10 Sticky navigation
 *       1.11 RWD Image Maps
 *       1.12 Form inputs
 *       1.13 KIS widget - On resize 
 *       1.14 MegaMenu
 *       1.15 Funnelback Main Search - AJAX
 *       1.16 Funnelback Related Results - AJAX
 *       1.17 Positioning components on home page
 *       1.18 Positioning components on course page
 *       1.19 Sitewide search - query change
 *       1.20 Calendar - Events Page
 *       1.21 Gap between components: departments, business and knowledge
 *       1.22 Share button on mobile
 *       1.23 Border color on black tabs when mouse enter on li
 *       1.24 Map our campuses collapse on mobile
 *       1.25 Funnelback AZ Results - AJAX  
 *       1.26 Upcoming Events - Matrix Items - AJAX 
 *       1.27 A-Z Listing - changing letters, hide/show content
 *       1.28 Hide components if no results
 *       1.29 Search page - Filters
 *       1.30 Funnelback autocomplete + typeahead
 *       1.31 Gallery - Pausing players 
 *       1.32 Comment error list order
 *       1.33 Calendar - General Datepicker Setup
 *       1.34 Quote Box next element height alignment
 *       1.35 Leave a comment form actions
 *       1.36 Image with caption alignment
 *       1.37 Equalize height of elements 
 *       1.38 LHS Menu - last active page
 *       1.39 Save page floating
 *       1.40 Carousel - equal height for navigation items
 *       1.41 Multi-images blank img fix
 *       1.42 Megamenu Loader - Ajax  
 *
 *     2. On window load
 *     3. On window resize
 *     4. Document ready
 *
 *
 *     5. Functions
 *       5.1 Get Parameter 
 *       5.2 Tabs scrolling 
 *       5.3 Pagination - Listings
 *       5.5 Scroll to element
 *       5.6 GTM + Youtube API -- Lightbox fix
 *       5.7 Calendar functionality
 *       5.8 MyUniHub Login
 *
 *
 */

/*
 --------------------
 1. Modules
 --------------------
 */

/* -- 1.1 Announcement Bar -- */

var announcement = {
    setState: function(){
        jQuery('.announcement-close').click(function(){
            var cookie_name = jQuery('.announcements-wrapper').attr('data-cookie-name');
            jQuery.cookie(cookie_name, "off", { expires: 7, path: '/' });
            jQuery('.announcements-wrapper').parent('section').hide();
            return false;
        });
    },
    checkState: function(){
        var cookie_name_check = jQuery('.announcements-wrapper').attr('data-cookie-name');
        if ( jQuery.cookie(cookie_name_check) == undefined ){
            jQuery('.announcements-wrapper').show();
        }
    },
    init: function(){
      if ( jQuery('.announcements-wrapper').length > 0){
        announcement.setState();
        announcement.checkState();
      }
    }
};

/* -- 1.2 Saved Pages -- */

var saved_pages = {

    config: function(){
        jQuery.cookie.json = true;
    },

    checkState: function() {
        var current_id = jQuery('.page-save').attr('data-id');


        if (jQuery.cookie('pages') == undefined){
            var pages_null = { "page": { "id": [] }};
            jQuery.cookie('pages', pages_null, { expires: 355, path: '/' });
            jQuery('.saved-pages-number').text('0');
        }
        else {
            var saved = jQuery.cookie('pages');
            for(var k in saved.page.id) {
                if (saved.page.id[k]['id'] == current_id) {
                    jQuery('.page-save').addClass('saved');
                }
            }

            jQuery('.middle-showcase li.showcase-item').each(function(){
                var showcase_id = jQuery(this).attr('id');
                for(var k in saved.page.id) {
                    if (saved.page.id[k]['id'] == showcase_id) {
                        jQuery(this).find('.favourite').addClass('active');
                    }
                }
            });

            jQuery('.saved-pages-number').text(saved.page.id.length);
        }

        jQuery('.page-save').click(function(){
            var thisEl = jQuery(this);

            var saved = jQuery.cookie('pages');
            var current_id = thisEl.attr('data-id');
            var item_name = thisEl.attr('data-name');
            var item_url = thisEl.attr('data-url');

            if ( thisEl.hasClass('saved') ) {

                // remove page
                for(var k in saved.page.id) {
                    if (saved.page.id[k]['id'] == current_id) {
                        saved.page.id.splice(k, 1);
                        jQuery.cookie('pages', saved, { expires: 355, path: '/' });

                        if (thisEl.hasClass('course-save-button')) {
                            jQuery('.tabbed-content li').find('.page-save').removeClass('saved');
                        } else {
                            thisEl.removeClass('saved');
                        }
                    }
                }
                saved_pages.createList();
                jQuery('.saved-pages-number').text(saved.page.id.length);
 
            }
            else {

                // save page
                if (saved.page.id.length > 9) {
                    alert('You can save max 10 pages');
                } else {
                    saved.page.id.push({'id': current_id, 'name': item_name, 'url': item_url});
                    jQuery.cookie('pages', saved, { expires: 355, path: '/' });
                    
                    if (thisEl.hasClass('course-save-button')) {
                        jQuery('.tabbed-content li').find('.page-save').addClass('saved');
                    } else {
                        thisEl.addClass('saved');
                    }
                    jQuery('.saved-pages-number').text(saved.page.id.length);
                    saved_pages.createList();
                }
            }
        });

        jQuery('.favourite').click(function(e){
            e.preventDefault();
            var thisEl = jQuery(this);
            var saved = jQuery.cookie('pages');
            var current_id = thisEl.attr('data-id');
            var item_name = thisEl.attr('data-name');
            var item_url = thisEl.attr('data-url');

            if ( thisEl.hasClass('active') ) {

                // remove page
                for(var k in saved.page.id) {
                    if (saved.page.id[k]['id'] == current_id) {
                        saved.page.id.splice(k, 1);
                        jQuery.cookie('pages', saved, { expires: 355, path: '/' });
                        thisEl.removeClass('active');
                    }
                }
                jQuery('.saved-pages-number').text(saved.page.id.length);
                saved_pages.createList();
            }
            else {
                // save page
                if (saved.page.id.length > 9) {
                    alert('You can save max 10 pages');
                } else {
                    saved.page.id.push({'id': current_id, 'name': item_name, 'url': item_url});
                    jQuery.cookie('pages', saved, { expires: 355, path: '/' });
                    thisEl.addClass('active');
                    jQuery('.saved-pages-number').text(saved.page.id.length);
                    saved_pages.createList();
                }
            }
        });
    },

    createList: function(){

        jQuery('.saved-elements-list').html('');
        jQuery('.saved-elements-message').remove();

        var saved = jQuery.cookie('pages');
        var id = "";
        var name = "";
        var url = "";

        for(var k in saved.page.id) {
            id = saved.page.id[k]['id'];
            name = saved.page.id[k]['name'];
            url = saved.page.id[k]['url'];

            jQuery('.saved-elements-list').append('<li><a href="'+url+'">'+name+'</a><span data-id="'+ id +'" class="delete"></span></li>');
        }
    },

    button: function(){
      var saved = jQuery.cookie('pages');
      if ((saved.page.id.length === 0) && (jQuery('.saved-elements-message').length === 0)) {
        jQuery('.saved-elements').prepend('<p class="saved-elements-message">You have no saved pages</p>');
      } else {
           jQuery('.saved-elements-message').remove();
           saved_pages.createList();
      }
      jQuery(document).on({



          click: function(e){
          e.preventDefault();

            /*var saved = jQuery.cookie('pages');
            if ((saved.page.id.length === 0) && (jQuery('.saved-elements-message').length === 0)) {
              jQuery('.saved-elements').prepend('<p class="saved-elements-message">You have no saved pages</p>');
            } else {
                jQuery('.saved-elements-message').remove();
                saved_pages.createList();
            }*/
            if($('.homepage').length == 0 || $(window).width() < 911) {
                jQuery('.saved-elements').toggle(); 
            } else {
                jQuery('.saved-elements').css("display", "block");
            }            
        }
      }, '.saved-pages > span, .saved-pages .arrow, .saved-pages .saved-pages-number, .saved-elements-close');

    },

    removeButton: function(){

      jQuery(document).on({
        click: function(e){
          e.preventDefault();

          var saved = jQuery.cookie('pages');
          var current_id = jQuery(this).attr('data-id');

          for(var k in saved.page.id) {
            if (saved.page.id[k]['id'] == current_id) {
                saved.page.id.splice(k, 1);
                jQuery.cookie('pages', saved, { expires: 355, path: '/' });
                jQuery(this).parent().remove();
                jQuery('body').find("[data-id='" + current_id + "']").removeClass('active').removeClass('saved');
            }
          }
          if (saved.page.id.length === 0) {
            jQuery('.saved-elements').prepend('<p class="saved-elements-message">You have no saved pages</p>');
            jQuery('.saved-elements-list').html('');
          //  jQuery('.saved-elements-message').html('You have no saved pages');
          }        
          jQuery('.saved-pages-number').text(saved.page.id.length);
        }
      }, '.saved-elements-list li span.delete');

    },

    init: function(){
        saved_pages.config();
        saved_pages.checkState();
        saved_pages.createList();
        saved_pages.button();
        saved_pages.removeButton();
    }

};


/* -- 1.3 Tabs -- */

var tabs = {

    action: function(){
        var tabContent = null;
        jQuery('.tabbed-navigation a').on('click', function(e){
            e.preventDefault();
            var pageName = window.location.href;
            pageName = pageName.replace("_nocache","").replace("_recache","");

            var tab_id = jQuery(this).attr('data-tab');
            // if analytics is added - track tabs
            if (window.ga) { 
              tabs.trackTabEvent(jQuery(this).find("span").text(), pageName);  
            } 
            

            jQuery('.tabbed-navigation li').removeClass('active');
            jQuery(this).parent().addClass('active');
            jQuery('.tabbed-content li').removeClass('active');
            
            tabContent = jQuery(".tabbed-content").find("[data-tab='"+ tab_id +"']");
            tabContent.addClass('active');
            if ((tabContent.is(":visible") === true) && (tabContent.find("ul.slides").length > 0)){ // fix for flexSlider issue on hidden cards
              tabContent.find(".carousel-container").resize();
              tabContent.find(".carousel-navigation").resize();
            }

            //var tab_elements = tabContent.find('.component');
            //equalBoxes.resize_boxes(tab_elements);

        });
    },

    fav_tab: function(){
        if (getParam(location.href,'tab')) {
            var fav_tab = getParam(location.href,'tab');
            jQuery('.tabbed-navigation li, .tabbed-content li').removeClass('active');
            jQuery('.tabbed-navigation li').find("[data-tab-name='" + fav_tab + "']").parent().addClass('active');
            jQuery('.tabbed-content').find("[data-tab-name='" + fav_tab + "']").addClass('active');
        }        
    },

    scrolling_tabs: function(){
        if (jQuery(window).width() > 800) {
        
            var tab_w = 0;

          if (jQuery('.tabbed-navigation li').length > 0) {
            jQuery('.tabbed-navigation li').each(function() { 
                   //jQuery(this).width( Math.ceil( jQuery(this).width() + 1 ) );
               tab_w = tab_w + jQuery(this).outerWidth(); 
            });
            tab_w += 3;
            var active_width = jQuery('.tabbed-navigation li.active').outerWidth() + 2;
            var active_pos_arr = jQuery('.tabbed-navigation li.active').position();
            if (typeof active_pos_arr !== "undefined") {
                var active_pos = Math.round(active_pos_arr.left);
                var active_box = active_width + active_pos;
            }
            var tab_box = jQuery('.tabbed-menu-scroll').outerWidth();
            if (tab_box <= tab_w) {
                jQuery('.tabbed-navigation').outerWidth(tab_w);
                jQuery('.tabbed-menu-scroll').addClass('scroll-on');
                if (!jQuery('.tab-forward').length) {
                    var tab_arrows = '<span class="tab-back"></span><span class="tab-forward"></span>';
                    jQuery('.box-scroll').prepend(tab_arrows);

                    jQuery('.tab-forward').off("mousedown").off("mouseup");
                    jQuery('.tab-back').off("mousedown").off("mouseup");

                    jQuery('.tab-forward').mousedown(scroll_forward).mouseup(stopScrolling);
                    jQuery('.tab-back').mousedown(scroll_back).mouseup(stopScrolling);
                }
            } else {
                jQuery('.tab-forward').remove();
                jQuery('.tab-back').remove();
                jQuery('.tabbed-menu-scroll').removeClass('scroll-on');
                jQuery('.tabbed-navigation').width('');
            }
          }
        } else {
            jQuery('.tab-forward').remove();
            jQuery('.tab-back').remove();
            jQuery('.tabbed-menu-scroll').removeClass('scroll-on');
            jQuery('.tabbed-navigation').width('');
            jQuery('.tabbed-navigation>li').width('');
        }
    },
    trackTabEvent: function(tabName, pageName){
      ga('send', 'event', 'Tab', 'click', tabName+ ": " + pageName);
    },
    init: function(){
        tabs.action();
        if (!jQuery('body').hasClass('profile')) {
          tabs.scrolling_tabs();
        }
        //tabs.scrolling_tabs();
        tabs.fav_tab();
    }

};



/* -- 1.4 Responsive Navigation -- */

var mobile_navigation = {

    action: function(){

        var page_container = jQuery('.page-container');
        var mobile_nav = jQuery('.mobile-nav');

        mobile_nav.css('right', '-240px');

        jQuery(".show-mobile-nav-icon, .navigation-close").click(function(){
            if (jQuery('.show-mobile-nav-icon').hasClass('active')) {
                page_container.animate({ left: '+=240' }, 500, function() { mobile_nav.hide(); });
                mobile_nav.animate({ right: '-=240' }, 500);
                jQuery('.show-mobile-nav-icon').removeClass('active');
            } else {
                page_container.animate({ left: '-=240' }, 500);
                mobile_nav.show().animate({ right: '+=240' }, 500);
                jQuery('.show-mobile-nav-icon').addClass('active');
            }
        });

        jQuery(window).resize(function () {
            var page_w = window.innerWidth || jQuery(window).width();
            
            //var page_w = jQuery(window).width();
            mobile_navigation.resize(page_container, mobile_nav, page_w);
            // sticky search bar width fix
            //var searchBarWidth = jQuery('.search-and-saved-wrapper').width();
            //jQuery('.search-and-saved').width(searchBarWidth); 
        });
    },

    resize: function(p_cont, m_nav, p_width){

        if (p_width < 769 && jQuery('.show-mobile-nav-icon').hasClass('active') ) {
            p_cont.css('left', '-240px');
            m_nav.css('right', '0px').show();
        } else {
            m_nav.hide();
            p_cont.css('left', '0');
        }
    },

    init: function(){
        mobile_navigation.action();
    }
};

/* -- 1.5 Gallery Component -- */

var gallery_component = {

    create: function(){
        if (jQuery('.carousel-container').length > 0) {

            jQuery('.carousel-container').each(function(){

                var gid = jQuery(this).attr('data-id');
                var g_cont = '.g-cont_'+gid;
                var g_nav = '.g-nav_'+gid;
                jQuery(this).find('.carousel-content').addClass('g-cont_'+gid);
                jQuery(this).find('.carousel-navigation').addClass('g-nav_'+gid);

                var slideShowOption = false;
                var animationLoopOption = false;
                var maxNumItems = 3;
                var moveItems = 0;
                var directionNavOption = false;
                var afterLoad = function(){}
 
                if($(this).hasClass("text-carousel")) {
                    var slideShowOption = true;
                    var animationLoopOption = true;
                    var maxNumItems = 4;
                    var directionNavOption = true;
                    var afterLoad = function() {

                        $('.text-carousel .flex-viewport li a').on('mouseover',function(){
                            $(this).trigger('click');
                            if ($('.unihub-site').length > 0) {
                            	var newHeader = $(this).find('.carousel-navigation-bottom-text > h5').text();
                            	$('.unihub-site .text-carousel .item-title span').text(newHeader);
                            }
                        });

                        if ($('.unihub-site').length > 0) {
                        	$('.text-carousel .flex-viewport li a').on('click', function(e){
	                        	if (e.originalEvent !== undefined) {
	                        		var newUrl = $('.flex-active-slide > a').attr('href');
	                        		window.location.href = newUrl;
	                        	}                        		
	                        });
                        }
                        
                        return afterLoad;
                    }
                }

                jQuery(g_cont).flexslider({
                    animation: "fade",
                    controlNav: false,
                    directionNav: directionNavOption,
                    slideshow: slideShowOption,
                    //video: true,
                    animationLoop: animationLoopOption,
                    //sync: g_nav,
                    before: function(slider){
                       // $( slider.slides.eq(slider.currentSlide).find('iframe').attr('id') ).api('pause');
                       // $(player).api('pause');
                    },
                    after: function(){
                       gtmYoutubeApi.execute();
                       var slideIndex = $(".carousel-content li.flex-active-slide").index();
                       $(".carousel-navigation li.flex-active-slide").removeClass("flex-active-slide active");
                       $(".carousel-navigation li").eq(slideIndex).addClass("flex-active-slide active");
                       if ($('.unihub-site').length > 0) {
                        	var newHeader = $('.flex-active-slide.active .carousel-navigation-bottom-text > h5').text();
                        	$('.unihub-site .text-carousel .item-title span').text(newHeader);
                        	var newUrl = $('.flex-active-slide > a').attr('href');
							$('.carousel-container .item-title > a').attr('href',newUrl);
                       }
                    }
                    /*
                    after: function(slider){
                        jQuery(this).find(g_nav+' ul li').removeClass('active');
                        jQuery(this).find(g_nav+' ul li').eq(slider.currentSlide).addClass('active');
                    }
                    */
                });

                jQuery(g_nav).flexslider({
                    animation: "slide",
                    animationSpeed:200,
                    controlsContainer: g_nav,
                    controlNav: false,
                    animationLoop: false,
                    slideshow: false,
                    itemMargin: 0,
                  //  move: 1,
                  //  minItems: 1,
                    maxItems: maxNumItems,
                    itemWidth: jQuery(this).find(g_nav+' li').width(),
                    asNavFor: g_cont,
                    start:afterLoad
                });

            });

			if ($('.unihub-site').length > 0) {
            	var newHeader = $('.flex-active-slide.active .carousel-navigation-bottom-text > h5').text();
            	$('.unihub-site .text-carousel .item-title span').text(newHeader);
            	var newUrl = $('.flex-active-slide > a').attr('href');
				$('.carousel-container .item-title > span').wrap('<a href="' + newUrl + '"></a>');
            }
        }





    },

    touchEvent: function(){

        jQuery(".carousel-content").swipe( {
            swipe:function(event, direction, distance, duration, fingerCount) {
                var current_slider = '.g-cont_'+(jQuery(this).parents('.carousel-container').attr('data-id'));
                if (direction == 'left') {
                    jQuery(current_slider).flexslider("next");
                } else if (direction == 'right') {
                    jQuery(current_slider).flexslider("prev");
                }
            },
            threshold:10
        });

    },

    init: function() {
        gallery_component.create();
        gallery_component.touchEvent();
    }
};

var campaign_gallery_component = {

    create: function(){
        if (jQuery('.campaign-carousel-container').length > 0) {

            jQuery('.campaign-carousel-container').each(function(){

                var gid = jQuery(this).attr('data-id');
                var g_cont = '.g-cont_'+gid;
                var g_nav = '.g-nav_'+gid;
                jQuery(this).find('.carousel-content').addClass('g-cont_'+gid);
                jQuery(this).find('.carousel-navigation').addClass('g-nav_'+gid);

                var slideShowOption = false;
                var animationLoopOption = true;

                var maxNumItems = 3;
                var moveItems = 0;
                var directionNavOption = false;
                var afterLoad = function(){}

                if($(this).hasClass("text-carousel")) {
                    var slideShowOption = true;
                    var animationLoopOption = true;
                    var maxNumItems = 4;
                    var directionNavOption = true;
                    var afterLoad = function() {

                        $('.text-carousel .flex-viewport li a').on('mouseover',function(){
                            $(this).trigger('click');
                            if ($('.unihub-site').length > 0) {
                            	var newHeader = $(this).find('.carousel-navigation-bottom-text > h5').text();
                            	$('.unihub-site .text-carousel .item-title span').text(newHeader);
                            }
                        });

                        if ($('.unihub-site').length > 0) {
                        	$('.text-carousel .flex-viewport li a').on('click', function(e){
	                        	if (e.originalEvent !== undefined) {
	                        		var newUrl = $('.flex-active-slide > a').attr('href');
	                        		window.location.href = newUrl;
	                        	}
	                        });
                        }

                        return afterLoad;
                    }
                }

                jQuery(g_cont).flexslider({
                    animation: "fade",
                    controlNav: false,
                    directionNav: directionNavOption,
                    slideshow: slideShowOption,
                    //video: true,
                    animationLoop: animationLoopOption,
                    //sync: g_nav,
                    before: function(slider){
                       // $( slider.slides.eq(slider.currentSlide).find('iframe').attr('id') ).api('pause');
                       // $(player).api('pause');
                    },
                    after: function(){
                       gtmYoutubeApi.execute();
                       var slideIndex = $(".carousel-content li.flex-active-slide").index();
                       $(".carousel-navigation li.flex-active-slide").removeClass("flex-active-slide active");
                       $(".carousel-navigation li").eq(slideIndex).addClass("flex-active-slide active");
                       if ($('.unihub-site').length > 0) {
                        	var newHeader = $('.flex-active-slide.active .carousel-navigation-bottom-text > h5').text();
                        	$('.unihub-site .text-carousel .item-title span').text(newHeader);
                        	var newUrl = $('.flex-active-slide > a').attr('href');
							$('.campaign-carousel-container .item-title > a').attr('href',newUrl);
                       }
                    }
                    /*
                    after: function(slider){
                        jQuery(this).find(g_nav+' ul li').removeClass('active');
                        jQuery(this).find(g_nav+' ul li').eq(slider.currentSlide).addClass('active');
                    }
                    */
                });

                jQuery(g_nav).flexslider({
                    animation: "slide",
                    animationSpeed:200,
                    controlsContainer: g_nav,
                    controlNav: false,
                    animationLoop: false,
                    slideshow: false,
                    itemMargin: 0,
                  //  move: 1,
                  //  minItems: 1,
                    maxItems: maxNumItems,
                    itemWidth: jQuery(this).find(g_nav+' li').width(),
                    asNavFor: g_cont,
                    start:afterLoad
                });

            });

			if ($('.unihub-site').length > 0) {
            	var newHeader = $('.flex-active-slide.active .carousel-navigation-bottom-text > h5').text();
            	$('.unihub-site .text-carousel .item-title span').text(newHeader);
            	var newUrl = $('.flex-active-slide > a').attr('href');
				$('.campaign-carousel-container .item-title > span').wrap('<a href="' + newUrl + '"></a>');
            }
        }





    },

    touchEvent: function(){

        jQuery(".carousel-content").swipe( {
            swipe:function(event, direction, distance, duration, fingerCount) {
                var current_slider = '.g-cont_'+(jQuery(this).parents('.campaign-carousel-container').attr('data-id'));
                if (direction == 'left') {
                    jQuery(current_slider).flexslider("next");
                } else if (direction == 'right') {
                    jQuery(current_slider).flexslider("prev");
                }
            },
            threshold:10
        });

    },

    init: function() {
console.log("tss");
        campaign_gallery_component.create();
        campaign_gallery_component.touchEvent();
    }
};


/* -- 1.6 Cookies notification -- */

var cookies_notification = {
    setState: function(){
        jQuery('.cookies-wrapper .continue').click(function(){
            jQuery.cookie("cookies_info", "off", { expires: 355, path: '/' });
            jQuery('.cookies-wrapper').hide();
            jQuery('.footer-container').removeClass('footer-cookies');
            return false;
        });
    },
    checkState: function(){
        if ( jQuery.cookie("cookies_info") == undefined ){
            jQuery('.cookies-wrapper').show();
        }
    },
    init: function(){
        cookies_notification.setState();
        cookies_notification.checkState();
    }
};

/* -- 1.7 Share widget -- */


var share_widget = {

    action: function(){
        jQuery('.share-container').hover(function() {
          jQuery(this).stop(true,false).animate({ width: '95px'}, 500); }, function(){
        jQuery(".share-container").stop(true,false).animate({width: "35px"}, 500); 
      });
    },

    init: function(){
        share_widget.action();
    }

};

/* -- 1.8 Promotional sliders + lightbox -- */

var promo_sliders = {

    colorboxAmount: "Slide {current} of {total}",

    setColorboxTitle: function() {
        var cbox_title = jQuery(this).find('.promo-area-text').text();
        return cbox_title;
    },

    promotional: function(){

        if (jQuery('.promotional').length > 0) {

            jQuery('.promotional').each(function(){

                var pid = jQuery(this).attr('data-id');
                var p_cont = '.promo-slider_'+pid;

                var max_popup_w =  (jQuery(window).width() < 480) ? '95%' : '50%';
                var max_popup_h = (jQuery(window).width() < 480) ? '95%' : '65%';
                var inner_popup_w = (jQuery(window).width() < 480) ? '95%' : '50%';
                var inner_popup_h = (jQuery(window).width() < 480) ? '95%' : '65%';

                jQuery(p_cont).flexslider({
                    animation: "slide",
                    directionNav: true,
                    controlNav: false,
                    minItems: 1,
                    rel: pid,
                    //smoothHeight: true,
                    animationLoop: false,
                    slideshow: false
                });

                jQuery(p_cont+' .image').colorbox({
                    animation: "slide",
                    title: promo_sliders.setColorboxTitle,
                    current: promo_sliders.colorboxAmount,
                    rel: pid,
                    inline: true,
                    smoothHeight: false,
                    animationLoop: false,
                    maxWidth: max_popup_w,
                    maxHeight: max_popup_h,
                    onComplete: function() {
                        jQuery('#colorbox').removeClass().addClass('cBox_images');
                    }
                });

                jQuery(p_cont+' .youtube, '+ p_cont + ' .vimeo').colorbox({
                    animation: "slide",
                    title: promo_sliders.setColorboxTitle,
                    current: promo_sliders.colorboxAmount,
                    rel: pid,
                    iframe: true,
                    video: true,
                    smoothHeight: false,
                    animationLoop: false,
                    maxWidth: max_popup_w,
                    maxHeight: max_popup_h,
                    innerWidth: inner_popup_w,
                    innerHeight: inner_popup_h,
                    onComplete: function() {
                        jQuery('#colorbox').removeClass().addClass('cBox_videos');
                        //console.log("This ran");
                        /*jQuery('.cBox_videos').append("<div class='gaq-videos'><script>_gaq.push(['_trackEvent', 'Video', 'View', 'The video has been watched.']);</script></div>");*/
                        gtmYoutubeApi.execute();

                    },
                    onCleanup: function() {
                        /*jQuery('.gaq-videos').remove();*/
                    }
                });

                jQuery(p_cont+' .flow-video').colorbox({
                    animation: "slide",
                    title: promo_sliders.setColorboxTitle,
                    current: promo_sliders.colorboxAmount,
                    rel: pid,
                    inline: true,
                    smoothHeight: false,
                    animationLoop: false,
                    maxWidth: max_popup_w,
                    maxHeight: max_popup_h,
                    innerWidth: inner_popup_w,
                    innerHeight: inner_popup_h,
                    onComplete: function() {
                        jQuery('#colorbox').removeClass().addClass('cBox_videos');
                    }
                });

            });

        }
    },

    init: function() {
        promo_sliders.promotional();
    }

};

/* -- 1.9 Showcase lightbox -- */

var showcase_component = {

    showcaseAmount: "{current} of {total}",

    setShowcaseTitle: function() {
        var cbox_title = jQuery(this).parents('.showcase-item').find('.item-content-cBox').html();
        return cbox_title;
    },

    action: function(){

        if (jQuery('.showcase_component').length > 0) {

            jQuery('.showcase_component').each(function(){

                var sid = jQuery(this).attr('data-id');
                var s_cont = '.showcase_'+sid;
                //var type_value = (jQuery('.showInMenu .typeOne').hasClass('selected')) ? 'SQ_LINK_TYPE_1' : 'SQ_LINK_TYPE_2';

                var max_popup_w =  (jQuery(window).width() < 580) ? '95%' : '55%';
                var max_popup_h = (jQuery(window).width() < 580) ? '85%' : '70%';
                var inner_popup_w = (jQuery(window).width() < 580) ? '95%' : '55%';
                var inner_popup_h = (jQuery(window).width() < 580) ? '85%' : '70%';

                var max_popup_width =  (jQuery(window).width() < 992) ? '80%' : '55%';
                var max_popup_height = (jQuery(window).width() < 992) ? '80%' : '70%';

                jQuery(s_cont+' ul li a.image').colorbox({
                   title: showcase_component.setShowcaseTitle,
                    current: showcase_component.showcaseAmount,
                    rel: sid,
                    photo: true,
                    scrolling: false,
                    scalePhotos: true,
                    maxHeight: '80%',
                    onComplete: function() {
                        //jQuery.colorbox.resize();
                        jQuery('#colorbox').removeClass().addClass('cBox_images');
                        var title_box = jQuery('#cboxContent > #cboxTitle span');
                        var title_h = (title_box.height() * -1);
                        title_box.parent().css('top', title_h - 5);
                        jQuery('.cboxPromotional-description').css('top', jQuery('#cboxLoadedContent').height() + 10);
                        jQuery('.cboxPromotional-description').show();
                    },
                    onLoad: function() {
                        jQuery('.cboxPromotional-description').hide();
                    }
                });

                jQuery(s_cont+' ul li a.youtube, '+ s_cont + ' ul li a.vimeo').colorbox({
                    title: showcase_component.setShowcaseTitle,
                    current: showcase_component.showcaseAmount,
                    rel: sid,
                    iframe: true,
                    maxWidth: max_popup_w,
                    maxHeight: max_popup_h,
                    innerWidth: inner_popup_w,
                    innerHeight: inner_popup_h,
                    onComplete: function() {
                        jQuery('#colorbox').removeClass().addClass('cBox_videos');
                        var title_box = jQuery('#cboxContent > #cboxTitle span');
                        var title_h = (title_box.height() * -1);
                        title_box.parent().css('top', title_h-5);
                        jQuery('.cboxPromotional-description').css('top',jQuery('#cboxLoadedContent').height()+10);
                        jQuery('.cboxPromotional-description').show();                    
                    },
                    onLoad: function() {
                        jQuery('.cboxPromotional-description').hide();
                    }
                });

                jQuery(s_cont+' ul li a.flow-video').colorbox({
                    title: showcase_component.setShowcaseTitle,
                    current: showcase_component.showcaseAmount,
                    rel: sid,
                    inline: true,
                    maxWidth: max_popup_w,
                    maxHeight: max_popup_h,
                    innerWidth: inner_popup_w,
                    innerHeight: inner_popup_h,
                    onComplete: function() {
                        jQuery('#colorbox').removeClass().addClass('cBox_videos');
                        var title_box = jQuery('#cboxContent > #cboxTitle span');
                        var title_h = (title_box.height() * -1);
                        title_box.parent().css('top', title_h-5);
                        jQuery('.cboxPromotional-description').css('top',jQuery('#cboxLoadedContent').height()+10);  
                        jQuery('.cboxPromotional-description').show();                     
                    },
                    onLoad: function() {
                        jQuery('.cboxPromotional-description').hide();
                    }
                });

            });
        }
    },

    init: function() {
        showcase_component.action();
       // equalizeComponentsImageHeight();
    }

};

/* -- 1.10 Sticky navigation -- */

var sticky_menu = {

    action: function() {

        var announce_height = 0;  
        var offset, distance;

        var top_head = Math.round(jQuery('header').height());
        if (jQuery('.announcements-wrapper').is(':visible')) {
            announce_height = Math.round(jQuery('.announcements-wrapper').height());
        }

        if ( (jQuery(window).scrollTop() > 40+announce_height) && (!jQuery('header').hasClass('menu_fixed')) ) {
            jQuery('.page-container').prepend('<div class="sticky_fix" style="height:102px; display:block">&nbsp;</div>');
            jQuery('header').addClass('menu_fixed').css('position','fixed');
            jQuery('.search-and-saved-wrapper').addClass('search-inner-fixed');
            //var searchBarWidth = jQuery('.search-and-saved-wrapper').width();
            if (jQuery('.site-navigation li.active').length) {
                offset = jQuery('.site-navigation li.active').offset();
                distance = jQuery('.site-navigation li.active').height() + offset.top;
                if (jQuery('header').hasClass('menu_fixed')) {
                    distance = distance - Math.round(jQuery(document).scrollTop());
                }
                jQuery('.megamenu-position').css('top',Math.floor(distance)+'px');
            }
        }
        else if ( jQuery(window).scrollTop() < 40+announce_height ) {
            jQuery('.sticky_fix').remove();
            jQuery('header').removeClass('menu_fixed').css('position','relative');
            jQuery('.search-and-saved-wrapper').removeClass('search-inner-fixed');
            if (jQuery('.site-navigation li.active').length) {
                offset = jQuery('.site-navigation li.active').offset();
                distance = jQuery('.site-navigation li.active').height() + offset.top;
                if (jQuery('header').hasClass('menu_fixed')) {
                    distance = Math.round(jQuery('.menu_fixed').outerHeight());
                }

                jQuery('.megamenu-position').css('top',Math.floor(distance-announce_height)+'px');
            }
           
        }

    },

    checkPosition: function() {

        jQuery(window).scroll(function(){
            sticky_menu.action();
        });

    },

    init: function() {
        sticky_menu.action();
        sticky_menu.checkPosition();
    }

};

/* -- 1.11 RWD Image Maps -- */

var rwd_image_maps = {

    action: function() {
        jQuery('img[usemap]').rwdImageMaps();
    },

    init: function() {
        rwd_image_maps.action();
    }

};

/* -- 1.12 Form Inputs -- */

var form_inputs = {
    action: function() {
        if (jQuery('.form-content').length) {
            //checkboxess
            jQuery('input[type="checkbox"]').each(function() {
                jQuery(this).addClass('no-vsibility');                 
                if (jQuery(this).prop('checked')===true) {                   
                        jQuery(this).next('label').addClass('checked');
                        jQuery(this).next('label').attr('data-checked', 1);                    
                    }
            });

            jQuery('input[type="checkbox"]').next('label').on('click', function(e){
                e.preventDefault();
                if (jQuery(this).attr('data-checked')==='1') {
                  jQuery(this).removeClass('checked');
                  jQuery(this).prev('input').prop("checked", false);
                  jQuery(this).attr('data-checked', 0);
                }
                else {
                   jQuery(this).addClass('checked');
                   jQuery(this).prev('input').prop("checked", true);
                   jQuery(this).attr('data-checked', 1);
                }
            });
            
            //radio buttons
            var name;
            
            jQuery('input[type="radio"]').each(function() {
                jQuery(this).addClass('no-vsibility');
                if (jQuery(this).prop('checked')===true) {
                    jQuery(this).next('label').addClass('checked');
                }
            });
            
             jQuery('input[type="radio"]').next('label').on('click', function(e){
                e.preventDefault();
                 name=jQuery(this).prev('input').attr('name');
                 jQuery('input[name="'+name+'"]').next().removeClass('checked');
                 jQuery(this).addClass('checked');
                 jQuery(this).prev('input').prop("checked", true);
            });
            
        }
    },

    onClickAction: function() {
        // hide placeholder on input/textarea click
        jQuery(document).on('focus', 'input, textarea', function(){
            if(jQuery(this).attr('placeholder')) {
                jQuery(this).data('placeholder', jQuery(this).attr('placeholder'));
                jQuery(this).attr('placeholder', '');
            }
        });

        jQuery(document).on('blur', 'input, textarea', function(){
            if(jQuery(this).data('placeholder')) {
                jQuery(this).attr('placeholder', jQuery(this).data('placeholder'));
            }
        });
    },
    
    init: function() {
        form_inputs.action();
        form_inputs.onClickAction();
    }

};













/* -- 1.x Custom -- */

var custom = {
    search_mobile: function(){
        var s_mob = jQuery('.block-site-search').clone();
        jQuery('.main-container').prepend(s_mob);
    },
    search_fields: function(){
      jQuery(".site-search input, .profile-filter input").focus(function() {
        if ( jQuery(this).val()==jQuery(this).attr('title') ) { 
          jQuery(this).val(''); 
        }
      }); // end focus
      jQuery(".site-search input, .profile-filter input").blur(function() {
        if (jQuery(this).val().length<1) { 
          jQuery(this).val(jQuery(this).attr('title')); 
        }
      }); // end blur
    },

    showcase_share: function(){
      jQuery('.showcase_component').find('.share').click(function(e) {
       e.preventDefault();
      });

      jQuery('.share .social_buttons li').mouseenter(function(){
        jQuery(this).click(function(){
          window.open(jQuery(this).attr('data-url'));
          return false;
        });
      });
    },

    rhs_share_buttons: function(){
      jQuery('.share-container .share-items a').click(function(e) {
        e.preventDefault();
      });
    },

    content_lightbox: function(){
      jQuery('.content-container .content img.lightbox').each(function(){
        var thisEl = jQuery(this);
        if (thisEl.parent('a').length === 0) {
         thisEl.wrap(function() {
           var data_url = thisEl.attr('src');
           var data_title = thisEl.attr('title');
           if (typeof(data_title) == 'undefined') { data_title = ''; }
           var data_rel = 'content_lightbox';
           return "<a class='"+data_rel+"' title='"+data_title+"' href='"+data_url+"'></a>";
         });
       }
       jQuery(".content_lightbox").colorbox(({rel:'content_lightbox'}));
     });
    },

    accordion_links: function(){

/*
        jQuery('.accordion li h6').on('click', function(){
            jQuery(this).parent().toggleClass('active');
            jQuery(this).parent().find('p').toggleClass('active');
        });
*/

       jQuery(document).on({
         click: function (e) {
           e.preventDefault();
           jQuery(this).parent().toggleClass('active');
           jQuery(this).parent().find('p').toggleClass('active');
         }
       }, '.accordion li h6');

       jQuery(document).on({
         touchstart: function (e) {
           e.preventDefault();
           jQuery(this).parent().toggleClass('active');
           jQuery(this).parent().find('p').toggleClass('active');
         }
       }, '.accordion li h6');

    },

    kis_widget_accordion: function(){
        jQuery('.kis-accordion').click(function(e){
            e.preventDefault();
            jQuery(this).toggleClass('active');
            jQuery(this).siblings('.kis-container').toggleClass('kis-collapsed');
            jQuery(this).children().children('.arrow').toggleClass('hide');
        });
    },

    profile_filter: function(){
        jQuery('.profile-filter input[type="text"]').keyup(function() {
            var thisBox = jQuery(this).parents('.component');
            var profiles = thisBox.find('ul li');
            var search_value = jQuery(this).val().toUpperCase();
            profiles.css('display', 'none');
            profiles.each(function() {
                var val = jQuery(this).find('.item-content h6').text().toUpperCase();
                if(val.indexOf(search_value) >= 0) {
                    jQuery(this).closest('li').css('display', 'block');
                }
            });
        });

    },

    international_filter: function(){
        jQuery('.international-select-box ul li a').click(function(e){
          e.preventDefault();
          var selected_value = jQuery(this).attr('data-id');
          var selected_text = jQuery(this).text();
          jQuery('.international-select').text(selected_text);
          jQuery('.international-boxes > div').addClass('hide');
          jQuery('.international-boxes').find("[data-id='" + selected_value + "']").toggleClass('hide');
        });
    },

    magnifier_icon: function() {

        jQuery('.search-icon').click(function(e) {
          e.preventDefault();
          if (jQuery('.homepage .block-site-search.global-search-container').length > 0) {
            jQuery('.homepage .main-container > .block-site-search.global-search-container').toggle();
          } else if(jQuery('.homepage .block-site-search.new-global-search-container').length > 0){
            jQuery('.homepage .main-container > .block-site-search.new-global-search-container').toggle();
          }else {
            jQuery('.search-and-saved-wrapper').toggle();
          }
        });
    },

   megamenu_columns: function() {
        var menuCount = [];
        var boxCount=jQuery('.megamenu>ul').length;
        var colCount, k, a, i, sumK, control, kk;

        for (var j=0; j<boxCount;j++) {
             menuCount[j]=[];
             sumK=0;
             colCount=0;
             a=1;
             kk=0;
             control=0;
             for (k=0; k<jQuery('.megamenu>ul').eq(j).find('.megamenu-section.dontsplit').length;k++) {
                  menuCount[j][k]= jQuery('.megamenu>ul').eq(j).children('div').find('.megamenu-section.dontsplit:eq('+k+')>ul>li').length;
                  sumK=sumK+jQuery('.megamenu>ul').eq(j).children('div').find('.megamenu-section.dontsplit:eq('+k+')>ul>li').length;
                  
                  if (!menuCount[j][k])  {
                    kk++;
                  }
                  kk++;
             }
             
             // 4 txt 
            if (jQuery('.megamenu>ul').eq(j).children('.mm-4cols').children('.dontsplit').length) {
              jQuery('<div class="col1 menu_cols first column "></div><div class="col2 menu_cols column"></div><div class="col3 menu_cols column"></div><div class="col4 column last menu_cols"></div>').appendTo(jQuery('.megamenu>ul').eq(j).children('.mm-4cols'));
               colCount=Math.round((sumK+kk)/4);

                for (i=0;i<k;i++) {

                    jQuery('.megamenu>ul').eq(j).children('.mm-4cols').find('.megamenu-section.dontsplit:eq('+i+')').clone().appendTo(jQuery('.megamenu>ul').eq(j).children('.mm-4cols').find('.col'+a));                
                   
                    if (menuCount[j].length === 4) { control = 3; }

                    if (!menuCount[j][i] && control===0) { 
                        control=control+2.1; 
                    } else if (!menuCount[j][i]) {
                        control=control+2.9;
                    } else {
                        control=control+0.5;
                    }
                    control=control+menuCount[j][i]; 
                    if ((control+menuCount[j][i+1])>=colCount && a<4 && control>2) {
                        a++;
                        control=0;
                    }

                }
               jQuery('.megamenu>ul').eq(j).children('.mm-4cols').children('.megamenu-section').remove();
              
            }
            
            // 1 feat 3txt
            if (jQuery('.megamenu>ul').eq(j).children('.mm-4cols').children('.mm-3c-text').length) {

                var featured_class = '';

                var featured_check = jQuery('.megamenu>ul').eq(j).children('.mm-4cols').find('.featured-items');
                if (featured_check.length === 0) {
                    featured_class = 'no-featured-box';
                }
              jQuery('<div class="col1 menu_cols first column '+featured_class+'"></div><div class="col2 menu_cols column '+featured_class+'"></div><div class="col3 column last menu_cols '+featured_class+'"></div>').appendTo(jQuery('.megamenu>ul').eq(j).find('.mm-3c-text'));
               colCount=Math.round((sumK+kk)/3);
                for (i=0;i<k;i++) {

                    jQuery('.megamenu>ul').eq(j).children('.mm-4cols').find('.megamenu-section.dontsplit:eq('+i+')').clone().appendTo(jQuery('.megamenu>ul').eq(j).children('.mm-4cols').find('.col'+a));                
                    
                    if (!menuCount[j][i] && control===0) {
                        control=control+2;
                    } else if (!menuCount[j][i]) {
                        control=control+1.2;
                    } else {
                        control=control+0.5;
                    }
                     
                    control=control+menuCount[j][i];                    
                     
                    if ((control+menuCount[j][i+1]+1)>colCount && a<3 && control>2) {
                        a++;
                        control=0;
                    }
                }
               jQuery('.megamenu>ul').eq(j).children('.mm-4cols').children('.mm-3c-text').children('.megamenu-section').remove();              
            }
            
            // 2 feat 1 txt
            if (jQuery('.megamenu>ul').eq(j).children('.mm-3cols').children('.mm-1c-text').length) {

                var featured_3col_class = '';
                var featured_3col = jQuery('.megamenu>ul').eq(j).children('.mm-3cols').find('.featured-items');
                if (featured_3col.length === 0) {
                    featured_3col_class = 'no-featured-box';
                }

              jQuery('<div class="col1 menu_cols first column '+featured_3col_class+'"></div><div class="col2 column last menu_cols '+featured_3col_class+'"></div>').appendTo(jQuery('.megamenu>ul').eq(j).children('.mm-3cols').children('.featured-items'));
                sumK=jQuery('.megamenu>ul').eq(j).children('.mm-3cols').children('.featured-items').children('li').length;
                colCount=Math.round(sumK/2);
                for (i=0;i<sumK;i++) {
                    jQuery('.megamenu>ul').eq(j).children('.mm-3cols').children('.featured-items').children('li:eq('+i+')').clone().appendTo(jQuery('.megamenu>ul').eq(j).children('.mm-3cols').find('.col'+a));                
                    
                    if (i+1===colCount*a) {
                        a++;
                    }                 
                }
               jQuery('.megamenu>ul').eq(j).children('.mm-3cols').children('.featured-items').children('li').remove();              
            }
        } // end for

        var window_height = jQuery(window).height() - 100;

        jQuery('.megamenu-position .megamenu > ul.second-level-list').each(function () {
          var current_height = jQuery(this).actual('height');
          if (current_height > window_height) {
            jQuery(this).addClass('mm-scroll');
            jQuery(this).children('div').height(window_height-50);
          }
        });

    
   },

   pagination_listings: function(){
     if (jQuery('.news-events-listing-pagination').length > 0){
        Pagination('.news-events-listing-pagination', 4);
     }

   },

   image_with_caption: function () {
	var div_elements_next_to_figure = '';
	div_elements_next_to_figure = jQuery('.content-container .content > div:not(.component):not(.listing):not(.listing-white-box)');
	if (div_elements_next_to_figure.length > 0) {
		div_elements_next_to_figure.each(function() {
			if (jQuery(this).next().hasClass('image-caption')) { 
				jQuery(this).css('margin-bottom','0');
			};
		});
	}
   },

    init: function(){
        custom.image_with_caption();
        custom.search_mobile();
        custom.search_fields();
        custom.showcase_share();
        custom.content_lightbox();
        custom.accordion_links();
        custom.kis_widget_accordion();
        custom.profile_filter();
        custom.international_filter();
        custom.magnifier_icon();
        //custom.megamenu_columns();
        custom.pagination_listings();
       // custom.rhs_share_buttons();
    }
};


/* -- 1.13 KIS widget - On resize -- */

var onResize = {

  kis_widget_type: function() {

      if (jQuery('.kis-horizontal').length > 0) {  

        var kis_horizontal, kis_vertical;

        if (jQuery(window).width() < 670) {  
          jQuery('.kis-horizontal').each(function(idx) {
            kis_vertical = jQuery(this).attr('data-widget-vertical-url'); 

            jQuery(this).find('iframe').attr('src', kis_vertical).css('height', '520px');
            jQuery(this).find('iframe').parent().css('width', '190px').css('margin', '0 auto');
            
          });

        } else {  

          jQuery('.kis-horizontal').each(function(idx) {
            kis_horizontal = jQuery(this).attr('data-widget-horizontal-url');
            
            jQuery(this).find('iframe').parent().removeAttr('style');
            jQuery(this).find('iframe').attr('src', kis_horizontal).removeAttr('style');
            
          });

        } return false;
      }
    },
    resize: function(){

    },

    init: function(){
        onResize.kis_widget_type();
        onResize.resize();
    }
};


/* -- 1.14 MegaMenu -- */

var megamenu = {

   toggle: function(){
    var leaveCheck;
    var timer, timer_blank;

    jQuery('.site-navigation li a').on('mouseover', function(e){

        var mm_hoverEl = jQuery(this).attr('data-mm-layout');

        if (mm_hoverEl !== 'disabled' && mm_hoverEl !== '') {
         
            e.preventDefault();
            var that = this;
            leaveCheck++; //checking if mouse is over mmenu
            var announce_h = 0;        

            var offset = $(this).parent().offset();
            var distance = $(this).parent().height() + offset.top;
            if ($('header').hasClass('menu_fixed')) {
                distance = $('.menu_fixed').outerHeight()-2;
            } else {
                if (jQuery('.announcements-wrapper').is(':visible')) {
                  announce_h = jQuery('.announcements-wrapper').height();
                }                
            }

            timer = setTimeout(function(){
                var selected_value = jQuery(that).attr('data-id');
                jQuery('.site-navigation li').removeClass('active');
                jQuery(that).parent().addClass('active');
                jQuery('.megamenu.wrap > ul').removeClass('mm-active').hide();
                jQuery('.megamenu-position').removeAttr('style');

                jQuery('.megamenu-position').css('top',Math.floor(distance-announce_h)+'px');
                jQuery('.megamenu.wrap').show();
                if (jQuery('.megamenu-position').hasClass('mm-loader')) {
                    jQuery('.megamenu-position.mm-loader').show();
                    jQuery('.megamenu.wrap').show();
                }
                jQuery('.megamenu.wrap').find("[data-id='"+selected_value+"']").show().addClass('mm-active');
            }, 500);

        } else {
            timer_blank = setTimeout(function() {
                jQuery('.megamenu.wrap').hide(); jQuery('.site-navigation li').removeClass('active'); 
            }, 500);
        }
    });

    function intervalCleaner(){
        if (typeof(timer) !== undefined) { clearInterval(timer); }
        if (typeof(timer_blank) !== undefined) { clearInterval(timer_blank); }
    }

    jQuery('.site-navigation li a').on('mouseout', function(e){
        intervalCleaner();
    });


    //jQuery('.megamenu.wrap').on('mouseover', intervalCleaner());


    jQuery('.megamenu.wrap').hover(function(){
        leaveCheck++;
        if (jQuery('.megamenu .second-level-list').hasClass('mm-active')) {
         jQuery('.megamenu.wrap').show();
        } else if (jQuery('.megamenu.wrap').find('.loading').length > 0){
         jQuery('.megamenu.wrap').show();
        } else {
         jQuery('.megamenu.wrap').hide();
        }
    });

    jQuery('.megamenu.wrap, .site-navigation').mouseleave(function() {
            $('.megamenu.wrap, .site-navigation').mouseover(function() {
               return true;
             });
            leaveCheck=0;
            setTimeout(function() {
                if(leaveCheck===0) {
                    jQuery('.megamenu.wrap').hide(); jQuery('.site-navigation li').removeClass('active'); 
                }
            }, 500);
  });

   },

   init: function(){
     megamenu.toggle();
   }
};



/* -- 1.15 Funnelback Main Search - AJAX -- */

var main_search_ajax = {

    submit_button: function(){
        jQuery(document).on({
          click: function(e){
           e.preventDefault();
           detachTypeahead();
           //var query = jQuery('.search-container form.site-search input.tt-input').val();
           var query = jQuery('.search-container form.site-search input.home-search-input').val();
           jQuery('.search-page').animate({opacity: 0.5});

           jQuery.ajax({ 
             url: GlobalVars.url.funnelback_global_url+"?collection="+GlobalVars.url.funnelback_collection_global+"&query="+query, 
             dataType: "html", 
             cache: true
             }).done(function(data) {
              jQuery('.search-page').html(data);
              jQuery('.search-page').animate({opacity: 1});
              attachTypeahead();
              search_page.closeFilters();
        search_page.openDefaults();
              multi_images();
           });
               
          }
        }, '.search-page .search-container form.site-search .site-search-submit');
    },

    suggestion_text: function(){
        jQuery(document).on({
          click: function(e){
           e.preventDefault();

           jQuery('.search-page').animate({opacity: 0.5});
           var fb_query = jQuery(this).attr('href');

           jQuery.ajax({ 
             url: GlobalVars.url.funnelback_global_url+fb_query, dataType: "html", cache: true }).done(function(data) { 
               jQuery('.search-page').html(data);
               jQuery('.search-page').animate({opacity: 1});
           });
          }
        }, '.search-intro .search-keyword a');
    },

    pagination: function(){
        jQuery(document).on({
          click: function(e){
           e.preventDefault();
           detachTypeahead();
           jQuery('.search-page').animate({opacity: 0.5});
           var fb_query = jQuery(this).attr('href');

           jQuery.ajax({ 
             url: GlobalVars.url.funnelback_global_url+fb_query, dataType: "html", cache: true }).done(function(data) { 
               jQuery('.search-page').html(data);
               jQuery('.search-page').animate({opacity: 1});
               jQuery("html, body").animate({ scrollTop: jQuery('.search-count').offset().top-65 }, 600);
               attachTypeahead(); 
               search_page.closeFilters();
        search_page.openDefaults();
               multi_images();
           });
          }
        }, '.search-page .search-pagination a.page-item');
    },

    tabs: function(){
      jQuery(document).on({
      click: function(e){
       e.preventDefault();
       detachTypeahead();
       jQuery('.search-page').animate({opacity: 0.5});
       var fb_query = jQuery(this).attr('href');

       jQuery.ajax({ 
        url: GlobalVars.url.funnelback_global_url+fb_query, dataType: "html", cache: true }).done(function(data) { 
           jQuery('.search-page').html(data);
           jQuery('.search-page').animate({opacity: 1});
           attachTypeahead();
           search_page.closeFilters();
        search_page.openDefaults();
           multi_images();
       });
      }
    }, '.search-page .tabbed-navigation a.main-search-tab');
    },

    search_filters: function(){
        jQuery(document).on({
          click: function(e){
           e.preventDefault();
           
           var query = jQuery('.search-container form.site-search input.typeahead').attr('value');
           var filters = '';

           if (jQuery(this).hasClass('checked')){ 
            jQuery(this).removeClass('checked');
           }
           else {
            filters = "&"+jQuery(this).prev().attr('name')+"="+jQuery(this).prev().attr('value');
           }

           jQuery('.search-aside .search-filters label').each(function(){
            if (jQuery(this).hasClass('checked')){
                filters += "&"+jQuery(this).prev().attr('name')+"="+jQuery(this).prev().attr('value');
            }
           });
           jQuery('.search-page').animate({opacity: 0.5});
           detachTypeahead();
           jQuery.ajax({ 
             url: GlobalVars.url.funnelback_global_url+"?query="+query+filters, dataType: "html", cache: true }).done(function(data) { 
               jQuery('.search-page').html(data);
               jQuery('.search-page').animate({opacity: 1});
               attachTypeahead();
               search_page.closeFilters();
        search_page.openDefaults();
               multi_images();
           });

          }
        }, '.search-aside .search-filters .filters label');
    },

    init: function(){
        main_search_ajax.submit_button();
        main_search_ajax.suggestion_text();
        main_search_ajax.pagination();
        main_search_ajax.tabs();
        main_search_ajax.search_filters();
    }

};


/* -- 1.16 Funnelback Related Results - AJAX -- */
var related_results = {

    funnelback: function(){

    if (jQuery('.funnelback-results')){
     jQuery('.funnelback-results').each(function(){

      //GlobalVars.url.funnelback_url

      var param_name, param_name_temp, soft_fb_query_param;
      var component_type = jQuery(this).attr('data-type');
      var column_type = jQuery(this).attr('data-layout');
      var layout_type = jQuery(this).attr('data-layout-version');
      var results_amount = jQuery(this).attr('data-amount');

      var more_url = jQuery(this).attr('data-more-url');
      var more_label = jQuery(this).attr('data-more-label');

      var this_item = jQuery(this);
      var global_page_type = jQuery(this).attr('data-page-type');

      var tagging_value = jQuery(this).attr('data-results-type'); 
      
      if (tagging_value === 'tagging'){

        var multiple_components_tags = jQuery(this).attr('data-global-page-tags-multiple-component');
        var query_exist = '';

        if (multiple_components_tags === undefined) {

            param_name = jQuery(this).attr('data-global-page-tags');

            if (param_name.length > 15) {
                param_name = param_name.replace(/; /g , '%22+%22');
                soft_fb_query_param = param_name;
                query_exist = 1;
            } else {
                query_exist = 0;
                this_item.closest('.component').hide();
                return;
            }

        } else {

            if (multiple_components_tags === '') {
                query_exist = 0;
                this_item.closest('.component').hide();
                return;
            } else {
                param_name = jQuery(this).attr('data-global-page-tags');
                param_name += '%22'+multiple_components_tags.replace(/; /g , '%22+%22')+'%22';
                soft_fb_query_param = param_name;
                query_exist = 1;
            /*
            param_name_temp = jQuery(this).attr('data-global-page-tags');
            soft_fb_query_param = jQuery(this).attr('data-global-page-tags');
            if (param_name_temp !== undefined) {
                param_name = param_name_temp.replace(/'/g , "%22");  
                soft_fb_query_param = soft_fb_query_param.replace(/'/g , "%22");    
            }
            */
            }
        }

      /* all results + tags 
      } else {
          query_exist = 1;
          param_name_temp = jQuery(this).attr('data-param');
          soft_fb_query_param = jQuery(this).attr('data-param');
          if (param_name_temp !== undefined) {
            param_name = param_name_temp.replace(/'/g , "%22");      
          }
      }
      */

      // results based on tags only (show only if tag exist)
      } else {

          param_name_temp = jQuery(this).attr('data-param');
          soft_fb_query_param = jQuery(this).attr('data-param');

          if (param_name_temp !== undefined) {
            var event_date = "&"+param_name_temp;
            var if_date = getParam(event_date,'meta_d3');

            if (if_date !== null) { 
                if (event_date.length > 35) { query_exist = 1; } else { query_exist = 0; this_item.closest('.component').hide(); } 
            } else { 
                query_exist = 1; 
            }

          } else {
            query_exist = 0;
            this_item.closest('.component').hide();
          }

          if (query_exist === 1) {
            if (param_name_temp.length > 0) {
            param_name = param_name_temp.replace(/='/g , "=%22").replace(/\+'/g , "+%22").replace(/'\+/g , "%22+");
            //param_name = param_name_temp.replace(/'/g , "%22");
            } else {
                query_exist = 0;
                this_item.closest('.component').hide();
            }
          }

      } // end if funnelback results



      var param_value = jQuery(this).attr('data-param-value');
      var collection = GlobalVars.url.funnelback_collection_global;
      var funnelback_url = GlobalVars.url.funnelback_url;
      var funnelback_get = GlobalVars.url.funnelback_related_url;
      var funnelback_all_results = GlobalVars.url.funnelback_all_listing_url;

      if (query_exist === 1) {
          jQuery.ajax({ url: funnelback_get+"?collection="+collection+"&"+global_page_type+"&"+param_name+"&num_ranks="+results_amount, dataType: "json", cache: true }).success(function(data) { 

            var json_ob = data;
            related_results.template_chooser(this_item, column_type, component_type, layout_type, json_ob);

            //check if read more url is filled and results amount>ammount - if not print read more url
            var current_page = this_item.find('.amount-data').attr('data-current-page');
            var total_pages = this_item.find('.amount-data').attr('data-total-pages');

            if (typeof(more_label) !== "undefined" && more_label.length>0 && parseInt(results_amount)<parseInt(json_ob.results.amount) && (typeof(more_url)==="undefined" || more_url.length===0) && this_item.parent().children('.view-all-bar').length===0) {
                // change orsand to and
                soft_fb_query_param = soft_fb_query_param.replace(/_orsand/g, '_and');
                var buttonHTML = '<a class="fb-ajax-more view-all-bar" href="'+funnelback_all_results+'?'+global_page_type+'&'+soft_fb_query_param+'">'+more_label+'</a>';
                this_item.parent().append(buttonHTML);           
            }

            var middle_element = this_item.parents('.content-container').length;
            if (middle_element > 0) {
              var use_elements = this_item.closest('.component');
              equalBoxes.resize_boxes(use_elements); // equalize elements
            }

          }); // end ajax call

        } // end if query exist

        jQuery('<img>').bind('load', function() {
          var use_elements = this_item.closest('.component');
          equalBoxes.resize_boxes(use_elements); // equalize elements
        });

        var use_elements = this_item.closest('.component');
        equalBoxes.resize_boxes(use_elements); // equalize elements

      }); // end each funnelback result
     }

    },

    funnelback_more_button: function(){

        jQuery(document).on({
            click: function(e){
                e.preventDefault();

                var fbBox = jQuery(this).siblings('.funnelback-results');

                var nextStart = fbBox.find('.amount-data').attr('data-next-start');
                var component_type = fbBox.attr('data-type');
                var column_type = fbBox.attr('data-layout');
                var layout_type = fbBox.attr('data-layout-version');
                var results_amount = fbBox.attr('data-amount');

                var more_url = fbBox.attr('data-more-url');
                var more_label = fbBox.attr('data-more-label');

                var this_item = fbBox;
                var global_page_type = fbBox.attr('data-page-type');
                var param_name_temp = fbBox.attr('data-param');

                if (param_name_temp !== undefined) {
                  var param_name = param_name_temp.replace(/'/g , "%22");      
                }
                //var param_name = param_name_temp.replace(/'/g , "%22");      

                var param_value = jQuery(this).attr('data-param-value');

                var collection = GlobalVars.url.funnelback_collection_global;
                var funnelback_url = GlobalVars.url.funnelback_url;
                var funnelback_get = GlobalVars.url.funnelback_related_url;

                //this_item.html('<div class="loading"></div>');
                this_item.animate({opacity: 0.5});


                jQuery.ajax({ url: funnelback_get+"?collection="+collection+"&"+global_page_type+"&"+param_name+"&num_ranks="+results_amount+"&start_rank="+nextStart, dataType: "json", cache: true }).success(function(data) { 

                // remove span with next results details
                this_item.find('.amount-data').remove();

                var json_ob = data;
                related_results.template_chooser(this_item, column_type, component_type, layout_type, json_ob);

                if (json_ob.results.currentPage === json_ob.results.totalPages) {
                    this_item.parent().find('.fb-ajax-more').remove(); // remove read more funnelback
                }

                //this_item.find('.loading').remove();

                this_item.animate({opacity: 1});
                multi_images();

                });

          }
        }, '.fb-ajax-more');

    },

    template_chooser: function(thisElement, column, component, layout, jsonEl){

        var this_item = thisElement;
        var column_type = column;
        var component_type = component;
        var layout_type = layout;
        var json_ob = jsonEl;
        var template;
        try {
            // print error
            if(json_ob.results.noResults) {
             var source   = no_results_found;
             template = Handlebars.compile(source);
             this_item.append(template(json_ob));
             this_item.find('.loading').remove();
             this_item.closest('.component').hide();
             this_item.closest('.component').removeClass('display-two-column');

            // print results
            } else {
                if (column_type === "sidebar") {

                    // check type of component and select proper template
                    if (component_type === "related_areas" || component_type === "related_projects" || component_type === "related_centers_and_groups"){
                        source = related_areas_groups_projects_centres_sidebar_template;
                    }
                    else if (component_type === "related_subjects"){
                        source = related_subjects_template;
                    }
                    else if (component_type === "related_schools"){
                        source = related_schools_template;
                    }
                    else if (component_type === "related_facilities"){
                        source = related_facilities_sidebar_template;
                    }
                    else if (component_type === "related_courses"){
                        if (layout_type === "single"){
                            source = related_courses_sidebar_single_template;
                        } else {
                            source = related_courses_sidebar_multiple_template;
                        }
                    }
                    else if (component_type === "related_news"){
                        if (layout_type === "single"){
                            source = related_news_sidebar_single;
                        } else {
                            source = related_news_sidebar_multiple;
                        }
                    }
                    else if (component_type === "related_events"){
                        if (layout_type === "single"){
                            source = related_events_sidebar_single;
                        } else {
                            source = related_events_sidebar_multiple;
                        }
                    }                    
                    else if (component_type === "departments"){
                        source = departments_template;
                    }
                    else if (component_type === "business_services_knowledge_transfer"){
                        source = business_services_knowledge_transfer_template;
                    }
                    else if (component_type === "staff_profiles"){
                        source = staff_profiles_sidebar_template;
                    }
                    else if (component_type === "featured_profiles"){
                        source = featured_profiles_sidebar_template;
                    }
                    else if (component_type === "student_profile"){
                        source = student_profile_sidebar_template;
                    }
                    else if (component_type === "case_study"){
                        source = case_study_sidebar_template;
                    }
                }

                else if (column_type === "middle") {

                    // check type of component and select proper template
                    if (component_type === "related_areas" || component_type === "related_projects" || component_type === "related_centers_and_groups"){
                        source = related_areas_groups_projects_centres_middle_template;
                    }
                    else if (component_type === "related_subjects"){
                        source = related_subjects_template;
                    }
                    else if (component_type === "related_schools"){
                        source = related_schools_template;
                    }
                    else if (component_type === "related_facilities"){
                        source = related_facilities_middle_template;
                    }
                    else if (component_type === "related_courses"){
                        if (layout_type === "single"){
                            source = related_courses_middle_single_template;
                        } else {
                            source = related_courses_middle_multiple_template;
                        }
                    }
                    else if (component_type === "related_news"){
                        if (layout_type === "single"){
                            source = related_news_middle_normal;
                        } else {
                            source = related_news_middle_large;
                        }
                    }    
                    else if (component_type === "related_events"){
                        if (layout_type === "single"){
                            source = related_events_middle_normal;
                        } else if (layout_type === "multiple") {
                            source = related_events_middle_large;
                        } else { 
                            source = related_events_middle_two_columns;
                        }
                    }                                        
                    else if (component_type === "departments"){
                        source = departments_template;
                    }
                    else if (component_type === "business_services_knowledge_transfer"){
                        source = business_services_knowledge_transfer_template;
                    }
                    else if (component_type === "staff_profiles"){
                        source = staff_profiles_middle_template;
                    }
                    else if (component_type === "featured_profiles"){
                        source = featured_profiles_middle_template;
                    }
                    else if (component_type === "student_profile"){
                        source = student_profile_middle_template;
                    }
                    else if (component_type === "case_study"){
                        source = case_study_middle_template;
                    }                    

                } else if (column_type === "both") {

                  if (component_type === "quick_links"){
                        source = quick_links_template;
                    }
                }

                template = Handlebars.compile(source);
                this_item.append(template(json_ob));
                this_item.find('.loading').remove();
                multi_images(); // create images

            }
          } catch (e) { }

          

    },

    init: function(){
      related_results.funnelback();
      //related_results.funnelback_more_button(); 
    }
};

var inResponsiveView = false;
/* -- 1.17 Positioning components on home page -- */
var ResponsiveHome = {
   init: function(){
      if((jQuery('body').hasClass('homepage') === true ) && inResponsiveView === false &&((jQuery(window).width() < 801) || (jQuery(document).width() < 801))) { 
       ResponsiveHome.reorder();
       inResponsiveView = true;
      } else {
          if(inResponsiveView === true && (jQuery(window).width() > 800)) {
           ResponsiveHome.reorderBack();
           inResponsiveView = false;
           }
       }    
   },
   reorder: function(){
     
     if (jQuery(".strip-visitUs__wrapper")) {
        jQuery('.content-container').prepend(jQuery('.strip-visitUs__wrapper'));
     }
     if (jQuery(".call-to-action-btns")){
        jQuery('.content-container').prepend(jQuery('.call-to-action-btns'));    
     }
     if (jQuery(".strip-carousel__wrapper")) {
        jQuery('.content-container').prepend(jQuery('.strip-carousel__wrapper'));
     }
     if (jQuery(".responsive-map-campuses")) {
        jQuery('.sidebar-right').append(jQuery('.responsive-map-campuses'));
     }
     if (jQuery(".quick-links")){
        jQuery('.sidebar-right').prepend(jQuery('.quick-links'));   
     }
     if (jQuery(".mdx-schools")){
        jQuery('.sidebar-right').prepend(jQuery('.mdx-schools'));   
     }
     if (jQuery(".iwbl")){
        jQuery('.iwbl').parent().parent().addClass('iwblDiv');
        jQuery('.sidebar-right').prepend(jQuery('.iwbl').parent().parent());   
     }
    
     if (jQuery(".content-container .block-site-search")){
        jQuery('.content-container').prepend(jQuery('.content-container .block-site-search'));    
     }  
   },
   reorderBack: function() {
     if (jQuery(".responsive-map-campuses")) {
        jQuery('.sidebar-left').append(jQuery('.responsive-map-campuses'));  
     }
     if (jQuery(".mdx-schools")){
        jQuery('.sidebar-left').prepend(jQuery('.mdx-schools'));
     }
     if (jQuery(".call-to-action-btns")){
        jQuery('.sidebar-right').prepend(jQuery('.call-to-action-btns'));
     }
     if (jQuery(".sidebar-left .block-site-search")){
        jQuery('.sidebar-left .block-site-search').after(jQuery('.strip-visitUs__wrapper'));    
     }  
     if (jQuery(".sidebar-left .block-site-search")){
        jQuery('.sidebar-left .block-site-search').after(jQuery('.strip-carousel__wrapper'));    
     } 
   }
};


/* -- 1.18 Positioning components on course page -- */
var ResponsiveCourse = {
   init: function(){
      if((jQuery('body').hasClass('course') === true ) && ((jQuery(window).width() < 801) || (jQuery(document).width() < 801))) {   
       ResponsiveCourse.reorder();
      }     
   },
   reorder: function(){
     if (jQuery(".course-header-image .multi-images")){
        jQuery('.course-header-image .multi-images').hide();
     }
     /*if (jQuery(".call-to-action-btns")){
        jQuery('.content-container').prepend(jQuery('.call-to-action-btns'));   
     }*/
     if (jQuery(".promotional")){
        jQuery('.content-container').prepend(jQuery('.promotional'));   
     }
     if (jQuery(".course-box")){
        var current_url = location.href;
        jQuery('.tabbed-content li.active, .tabbed-navigation li.active').removeClass('active');
        jQuery('.content-container .tabbed-navigation').append('<li><a href="'+current_url+'?tab=key-facts" data-tab-name="key-facts"><span>Key facts</span><div class="arrow"></div></a></li>'); 
        jQuery('.content-container .tabbed-content').append('<li data-tab="0000" data-tab-name="key-facts"><div class="tabbed-content-text">' + jQuery('.course-box').html() + '</div></li>');
        jQuery('.sidebar-right .course-box').remove();

        jQuery('.tabbed-navigation li:last-of-type a').click(function(e) { 
            e.preventDefault(); 
            jQuery('.tabbed-navigation li').removeClass('active'); 
            jQuery('.tabbed-content li').removeClass('active');
            jQuery(this).parent().addClass('active'); 
            jQuery('.tabbed-content li:last-of-type').addClass('active');
        });

     }
     if (jQuery(".related-courses-f")){
        jQuery('.sidebar-right').prepend(jQuery('.related-courses-f')); 
     }
     if (jQuery(".kis-widget")){
        jQuery('.sidebar-right').prepend(jQuery('.kis-widget')); 
     }
   }
};

/* -- 1.19 Sitewide search - query change -- */

var sitewide_search_query_changer = {
    check_page: function(){
        if (jQuery('form.site-search input.typeahead')) {
           sitewide_search_query_changer.init();
        }
    },
    init: function(){
        jQuery(document).on({
         keyup: function(){
          search_value = this.value;
          jQuery(this).attr('value', search_value);
         }
        }, 'form.site-search input.typeahead');
    }
};


/* -- 1.20 Calendar - Events Page -- */

var calendar_setup = {
    check_event_page: function(){
        if (jQuery('#datepicker').length) {
           calendar_setup.init();   
        }
    },
    init: function(){
      jQuery('#datepicker').datepicker({
        inline:true,
        showOtherMonths: true,
        altField: '#filter-date',
        onSelect: function() {
            jQuery('#filter-form').submit();
        },
        dateFormat: "dd/mm/yy"
      });
      jQuery('.events-filter-reset').click(function(){
        jQuery.datepicker._clearDate('#datepicker');
      });
      
      var url = window.location.href;
      var date = url.substring(url.indexOf('?date=') + 6);
      date = decodeURIComponent(date);
      jQuery('#datepicker').datepicker("setDate", date);
    }
};


/* -- 1.21 Gap between components: departments, business and knowledge -- */

/*var add_gaps = {
    width_check: function(){
      if((jQuery(window).width() > 767) || (jQuery(document).width() > 767)) {
        add_gaps.init();
      }
    },
    init: function() {
      if (jQuery('.content-container').find('.departments-f').next().is('.businesss-and-knowledge-f')) {
        jQuery('.content-container .departments-f').css({
            'margin-left':'0', 
            'width': '49%'
        }); 
        jQuery('.content-container .businesss-and-knowledge-f').css({
            'margin-right':'0', 
            'width': '49%'
        });
      } else if (jQuery('.content-container').find('.businesss-and-knowledge-f').next().is('.departments-f')) {
        jQuery('.content-container .departments-f').css({
            'margin-right':'0',
            'width': '49%'
        }); 
        jQuery('.content-container .businesss-and-knowledge-f').css({
            'margin-left':'0', 
            'width': '49%'
        });
      }
    }
}; */

/* -- 1.22 Share button on mobile -- */

var mobile_share_button = {
    mobile_only: function(){
        if((jQuery(window).width() < 767) || (jQuery(document).width() < 767)) {
            mobile_share_button.init();
        }
    },
    init: function(){
        jQuery('.mobile-nav-button-share').click(function() { jQuery('.social_buttons').toggle(); });
        jQuery('.mobile-nav-button-share > a').click(function(event) { event.preventDefault(); });

    }
};


/* -- 1.23 Border color on black tabs when mouse enter on li -- */

var border_color = {
    check_width: function(){
        if((jQuery(window).width() > 767) || (jQuery(document).width() > 767)) {
            border_color.init();
        }
    },
    init: function(){
        jQuery('.tabbed-navigation li').click(function () {
           jQuery('.tabbed-navigation li').find('a').removeClass("right-bar-black");
           jQuery(this).prev().find('a').addClass("right-bar-black");
        });
        jQuery('.tabbed-navigation li').hover(function() { 
            jQuery(this).prev().find('a').addClass("right-bar-black");
        },
        function() { 
            jQuery(this).prev().find('a').removeClass("right-bar-black");
            jQuery('.tabbed-navigation li.active').prev().find('a').addClass("right-bar-black");
        });
    }
};


/* -- 1.24 Map our campuses collapse on mobile -- */

var map_campuses_toggle = {
    init: function(){
        if (jQuery('.responsive-map-campuses')){
            jQuery('.responsive-map-campuses .map-header').click( function() { jQuery(this).parent().toggleClass('collapse-mobile'); });
        }
    }
};


/* -- 1.25 Funnelback AZ Results - AJAX -- */
var az_results = {

    funnelback: function(){

    var collection, source, template, param_name, param_name_temp;

    if (jQuery('.funnelback-results-az')){
     jQuery('.funnelback-results-az').each(function(){

      var this_item = jQuery(this);
      var global_page_type = jQuery(this).attr('data-page-type');
      var tagging_value = jQuery(this).attr('data-results-type'); 
      var funnelback_get = GlobalVars.url.funnelback_az_url;

      if (global_page_type === "meta_A=Staff profile") {
        collection = GlobalVars.url.funnelback_collection_profiles;
        global_page_type = '';
      } else {
        collection = GlobalVars.url.funnelback_collection_global;
      }

      
      if (tagging_value === 'tagging'){

        global_page_type = '';

        var multiple_components_tags = jQuery(this).attr('data-global-page-tags-multiple-component');
        if (multiple_components_tags !== undefined) {
            param_name = jQuery(this).attr('data-global-page-tags');
            param_name += '%22'+multiple_components_tags.replace(/; /g , '%22+%22')+'%22';
        } else {
            param_name_temp = jQuery(this).attr('data-global-page-tags');
            if (param_name_temp !== undefined) {
            param_name = param_name_temp.replace(/='/g , "=%22").replace(/\+'/g , "+%22").replace(/'\+/g , "%22+");
            //param_name = param_name_temp.replace(/'/g , "%22");  
            }
        }
      } else {
        param_name = jQuery(this).attr('data-param');    
        if (param_name !== undefined) {
            param_name = param_name.replace(/='/g , "=%22").replace(/\+'/g , "+%22").replace(/'\+/g , "%22+");
            //param_name = param_name.replace(/'/g , "%22");      
        }
      }


      jQuery.ajax({ url: funnelback_get+"?collection="+collection+"&"+global_page_type+"&"+param_name, dataType: "json", cache: true }).done(function(data) { 

        var json_ob = data;
        var noResults =  (json_ob.results[0].errorMsg !== undefined) ? 1 : 0;

        try {
          // print error
          
          if(noResults > 0) {
            source   = no_results_found;
            this_item.find('.loading').remove();
            this_item.closest('.component').hide();
            // print results
           } else {
             source = az_listing_template;
             template = Handlebars.compile(source);
             this_item.append(template(json_ob));
             this_item.find('.loading').remove();
             wrap_list('.funnelback-results-az .az-listing-results-box h5 + li');
             wrap_h5_with_list('.funnelback-results-az .az-listing-results-box h5, .funnelback-results-az .az-listing-results-box .ul-list');
             split_results_for_two_equal_columns('.funnelback-results-az .az-listing-results-box div .ul-list');    

             var all_button = this_item.find('.alphabet ul li').first().addClass('current');
             all_button.find('a').trigger('click');
           }
          } catch (e) { }

        });
      });
     }

    },
    init: function(){
      az_results.funnelback();
    }
};


/* -- 1.26 Upcoming Events - Matrix Items - AJAX -- */
var upcoming_events = {

    get_items: function(){

if (jQuery('.upcoming-events-results')){
     jQuery('.upcoming-events-results').each(function(){

      var source, template;
      var component_type = jQuery(this).attr('data-type');
      var column_type = jQuery(this).attr('data-layout');
      var layout_type = jQuery(this).attr('data-layout-version');
      var results_amount = jQuery(this).attr('data-amount');

      var this_item = jQuery(this);
      var global_page_type = jQuery(this).attr('data-page-type');
      var root_node = jQuery(this).attr('data-root-node');
      var param_value = jQuery(this).attr('data-param-value');
      var param_name = jQuery(this).attr('data-param');

      var events_json = GlobalVars.url.upcoming_events_json;
         
      jQuery.ajax({ url: events_json+"?"+root_node+"&"+param_name+"&num_ranks="+results_amount, dataType: "json", cache: true }).success(function(data) { 

      var json_ob = data;

        try {
            // print error
            if(json_ob.results.noResults) {
             source   = no_results_found;
             template = Handlebars.compile(source);
             this_item.append(template(json_ob));
             this_item.find('.loading').remove();
             this_item.closest('.component').hide();

            // print results
            } else {
              var json_length = json_ob.results.result.length;
                if (results_amount === "0") { results_amount = json_length; }
                if (results_amount > json_length) { 
                  length_all = json_length;
                } else { 
                  length_all = results_amount; 
                }

                var pos=0;
                for(var k in json_ob.results.result) {
                    var time = json_ob.results.result[pos]['timestamp'] - json_ob.results.result[pos]['today'];  
                    if (time < 0) { 
                       json_ob.results.result.splice(pos, 1);
                    }
                    else {
                        pos++;
                    }
                }

                if (json_ob.results.result.length>length_all) {
                    json_ob.results.result.splice(-(json_ob.results.result.length-length_all), json_ob.results.result.length-length_all);
                }

                if (column_type === "sidebar") {
                    // check type of component and select proper template
                    if (component_type === "related_events"){
                        if (layout_type === "single"){
                            source = related_events_sidebar_single;
                        } else {
                            source = related_events_sidebar_multiple;
                        }
                    }
                }

                else if (column_type === "middle") {
                    // check type of component and select proper template
                    if (component_type === "related_events"){
                        if (layout_type === "single"){
                            source = related_events_middle_normal;
                        } else if (layout_type === "multiple") {
                            source = related_events_middle_large;
                        } else { 
                            source = related_events_middle_two_columns;
                        }
                    }
                }

                template = Handlebars.compile(source);
                this_item.append(template(json_ob));
                this_item.find('.loading').remove();
            }
          } catch (e) { }

        });
      });
     }

    },
    init: function(){
      upcoming_events.get_items();
    }
};



/* -- 1.27 A-Z Listing - changing letters, hide/show content -- */

var az_letters = {
    change_letter: function(){
      jQuery(document).on({
        click: function(e){
         e.preventDefault();
         var letter = jQuery(e.target).text(); 
          if (letter == 'All') {
               jQuery(this).closest('ul').find('li').removeClass("current");
               jQuery(this).closest('.az-listing-content').find('.az-listing-results-box').find('div').show();
               jQuery(this).closest('li').addClass("current");
               jQuery(this).closest('.az-listing-content').find('.az-listing-results').find('.hidden').removeClass('hidden');
          } else { 
               jQuery(this).closest('ul').find('li').removeClass("current");
               jQuery(this).closest('.az-listing-content').find('.az-listing-results-box').children().hide();
               jQuery(this).closest('.az-listing-content').find('.az-listing-results-box').find('.'+ letter).show();
               jQuery(this).closest('li').addClass("current");
               jQuery(this).closest('.az-listing-content').find('.az-listing-results').find('.hidden').removeClass('hidden');
          }
        }
      }, '.alphabet a');
   },

   all_by_default: function(){
        var all_button = jQuery('.az-listing-content .alphabet ul li').first().addClass('current');
        all_button.find('a').trigger('click');
   },

    init: function(){
      az_letters.change_letter();
      az_letters.all_by_default();
    }
};

/* -- 1.28 Hide components if no results -- */
var hide_noResults = {
    init: function(){
      jQuery('.component-no-results').closest('.component').hide();
    }
};

/* -- 1.29 Search page - Filters -- */
var search_page = {
    closeFilters: function(){
      if (jQuery('.search-page .search-aside .search-filters').length > 0) {
    thisEl = jQuery('.search-page .search-aside .search-filters > li');
    jQuery(thisEl).each(function(i,j){
      if (i === 0) { 
        jQuery(this).addClass('active active-filter');
      } else { 
        if (!jQuery(this).find('.filters label.checked').length > 0) {
          jQuery(this).addClass('inactive-filter'); 
        } else {
              jQuery(this).addClass('active');
             // jQuery(this).addClass('active-filter');
            }
          }
        });
      }
    },
    toggleFilters: function(){
        jQuery(document).on({
          click: function (e) {
            e.preventDefault();
            var thisEl = jQuery(this);
            thisEl.siblings('.filters').slideToggle();
            if (thisEl.parent().is(':first-of-type')) {
              thisEl.parent().toggleClass('active active-filter');
            } else if (thisEl.parent().hasClass('inactive-filter')) {
              thisEl.parent().toggleClass('active');
            }
        }
      }, '.search-filters > li > a');
    },
    openDefaults: function() {
      var search_filters = jQuery(".search-filters");
      if (search_filters && search_filters.length) {
        var open_data = jQuery(".search-filters").data("open");
        if( $(window).width() > 800) {
          if (open_data && open_data.length) {
            jQuery(".inactive-filter:contains('" + open_data + "') a").click();
          }
        } else {
           jQuery(".active-filter a").click();
        }
      }
    },
    init: function(){
      if (jQuery('.search-page .search-aside .search-filters').length > 0) {
        search_page.closeFilters();
        search_page.toggleFilters();
        search_page.openDefaults();
      }
    }
};


/* -- 1.30 Funnelback autocomplete + typeahead -- */

var fb_server = GlobalVars.url.funnelback_server_url;
var fb_collection_courses = GlobalVars.url.funnelback_collection_courses;
var fb_collection_events = GlobalVars.url.funnelback_collection_news_events;
var fb_collection_global = GlobalVars.url.funnelback_collection_global;

var fbbaseUrl = fb_server
  , suggestPath = '/s/suggest.json'
  , fbcollectionCourses = fb_collection_courses
  , fbcollectionGlobal = fb_collection_global
  , fbcollectionEvents = fb_collection_events
  , limit = 3
  , limitGlobal = 5
  , coursesNumber = 0
  , eventsNumber = 0;

var bestResults = new Bloodhound({
  datumTokenizer: Bloodhound.tokenizers.obj.whitespace('value')
  , queryTokenizer: Bloodhound.tokenizers.whitespace
  , remote: {
    url: fbbaseUrl + suggestPath + '?collection=' + fbcollectionGlobal + '&partial_query=%QUERY&callback=?'
    , ajax: {
      dataType: 'jsonp'
    }
    , filter: function (list) {
      return $.map(list, function (el) {
        return {
          value: el
        };
      });
    }
  }
});
bestResults.initialize();
var ttadapterResults = bestResults.ttAdapter();

var detachTypeaheadResults = function () {
  jQuery('#home-fb-queryform .home-search-input, .search-and-saved .inner-search .top-search input.top-search-input').typeahead('destroy');
};

var attachTypeaheadResults = function () {
  jQuery('#home-fb-queryform .home-search-input,.search-and-saved  .inner-search .top-search input.top-search-input').typeahead(null, {
    displayKey: 'value'
    , source: ttadapterResults
  });
};

jQuery(function () {
  attachTypeaheadResults();
});

/* -- 1.30.1 Funnelback autocomplete + typeahead NEW */

var globalResults = new Bloodhound({
  datumTokenizer: Bloodhound.tokenizers.obj.whitespace('value')
  , queryTokenizer: Bloodhound.tokenizers.whitespace
  , remote: {
    url: fbbaseUrl + suggestPath + '?collection=' + fbcollectionGlobal + '&show=' + limitGlobal + '&partial_query=%QUERY&callback=?'
    , ajax: {
      dataType: 'jsonp'
    }
    , filter: function (list) {
      return $.map(list, function (el) {
        return {
          value: el
        };
      });
    }
  }
});

var courseResults = new Bloodhound({
  datumTokenizer: Bloodhound.tokenizers.obj.whitespace('disp.url')
  , queryTokenizer: Bloodhound.tokenizers.whitespace
  , remote: {
    url: fbbaseUrl + suggestPath + '?collection=' + fbcollectionCourses + '&show=' + limit + '&fmt=json++' + '&partial_query=%QUERY&callback=?'
    , ajax: {
      dataType: 'jsonp'
    }
  }
  , filter: function (list) {
    return $.map(list, function (el) {
      return {
        value: el
      };
    });
  }
});

var eventsResults = new Bloodhound({
  datumTokenizer: Bloodhound.tokenizers.obj.whitespace('disp.url')
  , queryTokenizer: Bloodhound.tokenizers.whitespace
  , remote: {
    url: fbbaseUrl + suggestPath + '?collection=' + fbcollectionEvents + '&show=' + limit + '&fmt=json++' + '&partial_query=%QUERY&callback=?'
    , ajax: {
      dataType: 'jsonp'
    }
  }
});

courseResults.initialize();
globalResults.initialize();
eventsResults.initialize();

var ttadapterCourses = courseResults.ttAdapter();
var ttadapterGlobal = globalResults.ttAdapter();
var ttadapterEvents = eventsResults.ttAdapter();

var top_search = (jQuery('.inner-search input.top-search-input').parent().hasClass('top-search')) ? ".topbar-search.inner-search .top-search input.top-search-input" : '';

var detachTypeahead = function () {
  jQuery(top_search).typeahead('destroy');
};

var attachTypeahead = function () {
  jQuery(top_search).typeahead({
    highlight: true
  }, {
    name: 'mdx-global'
    , displayKey: 'value'
    , source: ttadapterGlobal,

  }, {
    name: 'mdx-courses'
    , displayKey: 'disp.url'
    , source: ttadapterCourses
    , templates: {
      header: '<span class="tt-suggestions" style="display: block;"><div class="tt-suggestion-header"><p style="white-space: normal;">Courses</p></div></span>'
      , suggestion: function (data) {
        return '<a class="autosuggestion-item" href="' + data.disp.url + '">' + data.disp.title + '</a>';
      }
    }
  }, {
    name: 'mdx-events'
    , displayKey: 'disp.url'
    , source: ttadapterEvents
    , templates: {
      header: '<span class="tt-suggestions" style="display: block;"><div class="tt-suggestion-header"><p style="white-space: normal;">Events & News</p></div></span>'
      , suggestion: function (data) {
        return '<a class="autosuggestion-item" href="' + data.disp.url + '">' + data.disp.title + '</a>';
      }
    }
  })
};

jQuery(function () {
  attachTypeahead();
});


/* -- 1.31 Pausing players -- */
var pausePlayers = function() {
jQuery('.carousel-navigation .slides li').on('click',function() {
    if (!jQuery(this).hasClass('flex-active-slide')) {
        //flowplayer
        jQuery('.flowplayer').each(function(){
          api = $(this).data("flowplayer");
          api.pause();
        });
        //youtube
        jQuery('.youtube_player').each(function() {
            this.contentWindow.postMessage('{"event":"command","func":"pauseVideo","args":""}', '*');
        });
        //vimeo
        jQuery('.vimeo_player').each(function() {
            this.contentWindow.postMessage('{"method":"pause"}', '*');
        });
    }
});
};

/* -- 1.32 Comment error list order -- */
var comentErrorList = function() {
    if(jQuery('.news-comments .errors ul li:first').text().indexOf('Key')>-1) {
        jQuery('.news-comments .errors ul li:last').after(jQuery('.news-comments .errors ul li:first'));
    }
};

/* -- 1.33 Calendar - General Datepicker Setup -- */

var general_datepicker_setup = {
    init: function(){
        if (jQuery('.initDatePicker').length) {
            jQuery('.initDatePicker').datepicker({
                inline:true,
                showOtherMonths: true,
                altField: '#filter-date',
                dateFormat: "dd/mm/yy"
            });

            jQuery('.initDatePicker').datepicker("setDate", new Date());

            jQuery('.initDatePicker').each(function(){
                if (jQuery(this).data('related_datetime_question')) {
                    var tmp_date = jQuery(this).val().split('/'),
                        day_id = '#q' + jQuery(this).data('related_datetime_question') + '_value_d',
                        month_id = '#q' + jQuery(this).data('related_datetime_question') + '_value_m',
                        year_id = '#q' + jQuery(this).data('related_datetime_question') + '_value_y';

                    if (tmp_date.length >= 3) {
                        if (jQuery(day_id).length) {
                            jQuery(day_id).val(parseInt(tmp_date[0]));
                        }
                        if (jQuery(month_id).length) {
                            jQuery(month_id).val(parseInt(tmp_date[1]));
                        }
                        if (jQuery(year_id).length) {
                            jQuery(year_id).val(tmp_date[2]);
                        }
                    }
                }
            });

            jQuery(document).on('change', '.initDatePicker', function(){
                if (jQuery(this).data('related_datetime_question')) {
                    var tmp_date = jQuery(this).val().split('/'),
                        day_id = '#q' + jQuery(this).data('related_datetime_question') + '_value_d',
                        month_id = '#q' + jQuery(this).data('related_datetime_question') + '_value_m',
                        year_id = '#q' + jQuery(this).data('related_datetime_question') + '_value_y';

                    if (tmp_date.length >= 3) {
                        if (jQuery(day_id).length) {
                            jQuery(day_id).val(parseInt(tmp_date[0]));
                        }
                        if (jQuery(month_id).length) {
                            jQuery(month_id).val(parseInt(tmp_date[1]));
                        }
                        if (jQuery(year_id).length) {
                            jQuery(year_id).val(tmp_date[2]);
                        }
                    }
                }
            });
        }
    }
};

/* -- 1.34 Quote Box next element height alignment -- */
var quoteBoxFloatHeight = function() {
    if(jQuery('.quote-box-left').length || jQuery('.quote-box-right').length) {
        
        var qboxheight=0;
        
        jQuery('.quote-box-left, .quote-box-right').each(function() {
            qboxheight=jQuery(this).outerHeight();
            if(qboxheight>jQuery(this).next().outerHeight()) {
                jQuery(this).next().not('.component').height(jQuery(this).next().height()+qboxheight-jQuery(this).next().outerHeight());
            }
        });
    }
};

/* -- 1.35 Leave a comment form actions -- */
var leaveCommentFormActions = function() {
    if(jQuery('.leave-comment-destination').length) {
        var form_url = GlobalVars.url.leave_comment_form;

        if (jQuery('.leave-comment-destination').data('asset_id')) {
            var assetID = jQuery('.leave-comment-destination').data('asset_id');
            form_url += '?asset_id=' + assetID;

            if (jQuery('.leave-comment-destination').data('site-id')) {
                var site_root = jQuery('.leave-comment-destination').data('site-id');
                form_url += '&site_meta=' + site_root;
            }
        }

        jQuery.ajax({
            type: "GET",
            dataType: "html",
            url: form_url,
            success: function(data){
                jQuery('.leave-comment-destination').html(data);
            },
            error: function (jqXHR, status, errorThrown) {},
            complete: function() {
                jQuery('#sq_regen_captcha a').trigger('click');
            }
        });

        jQuery(document).on('submit', '.leave-comment-destination form', function() { 
            // inside event callbacks 'this' is the DOM element so we first 
            // wrap it in a jQuery object and then invoke ajaxSubmit 
            var self = $(this);
            $.ajax({
                url: self.attr('action'),
                type: 'POST',
                data: self.serialize(),
                beforeSend: function(data) {
                    if (!jQuery('.leave-comment-destination .loading').length) {
                        jQuery('.leave-comment-destination').html('<div class="loading"></div>');
                    }
                },
                success: function(data) {
                    jQuery('.leave-comment-destination').html(data);
                },
                error: function() {},
                complete: function() {
                    scrollToElement('.leave-comment-destination', 200, -130);
                    jQuery('#sq_regen_captcha a').trigger('click');
                }
            });
            // !!! Important !!! 
            // always return false to prevent standard browser submit and page navigation 
            return false; 
        });

        jQuery(document).on('click', 'input[type="checkbox"] + label', function(e){
            e.preventDefault();
            if (jQuery(this).attr('data-checked')==='1') {
              jQuery(this).removeClass('checked');
              jQuery(this).prev('input').prop("checked", false);
              jQuery(this).attr('data-checked', 0);
            }
            else {
               jQuery(this).addClass('checked');
               jQuery(this).prev('input').prop("checked", true);
               jQuery(this).attr('data-checked', 1);
            }
        });
    }
};

/* -- 1.36 Image with caption alignment -- */
var imageCaptionAlign = function() {
    
    if (jQuery('.image-caption').length) {
        
        if(jQuery('.image-caption>figure>img').width()<jQuery('.image-caption>figure>figcaption').width()) {
            jQuery('.image-caption>figure>figcaption').width(jQuery('.image-caption>figure>img').width());
        }
       
        if(jQuery('.image-caption.left').length || jQuery('.image-caption.right').length) {

            var boxheight=0;

            jQuery('.image-caption.left, .image-caption.right').each(function() {
                boxheight=jQuery(this).outerHeight();
                if(boxheight>jQuery(this).next().outerHeight()) {
                    jQuery(this).next().not('.component').height(jQuery(this).next().height()+boxheight-jQuery(this).next().outerHeight());
                }
            });
        }
        
    }
};

/* -- 1.37 Equalize height of elements -- */
var equalBoxes = {

    resize_boxes: function(thisBox) {

        var elements = typeof(thisBox) === 'undefined' ? jQuery('.main-container .content-container .content > .component') : thisBox;

        if (typeof(thisBox) !== 'undefined') {
            var amountOfElements = thisBox.find('.multi-images').length;
            if (amountOfElements > 100) { return false; }
        }

        jQuery(elements).each(function(){

          var minImageHeight = 500;
          var minContentHeight = 0;
          var thisEl = jQuery(this);
          var thisElImages = thisEl.find('.split-content .multi-images');
          var thisElContent = thisEl.find('.item-content, .facility-content');
          var amountOfElements = thisEl.find('.split-content .multi-images').length;
          if (amountOfElements > 100) { return false; }

          if (thisElImages.length > 0) {
              thisElImages.each(function(){
                if (jQuery(this).find('img').actual('height') < minImageHeight && jQuery(this).find('img').actual('height') > 0) {
                  minImageHeight = jQuery(this).find('img').actual('height');
                }
              });

              if ( thisElContent.length > 0) {
                jQuery(thisElContent).css('height', 'auto');

                thisElContent.each(function(){
                  if (jQuery(this).actual('height') > minContentHeight && jQuery(this).actual('height') >= 0) {
                    minContentHeight = jQuery(this).actual('height');
                  }
                });

                jQuery(thisElContent).height(minContentHeight);
              }

              if (thisEl.find('.showcase_area').length > 0) {
                var elHeight = minImageHeight + minContentHeight;
                jQuery(thisEl.find('a.showcase_area .multi-images')).height(minImageHeight);
                //jQuery(thisEl.find('a.showcase_area')).height(elHeight);
              } else {
                if (minImageHeight !== 500 && minImageHeight > 25) {
                  jQuery(thisElImages).height(minImageHeight);
                }
              }
          } else {
                if ( thisElContent.length > 0) {
                    jQuery(thisElContent).css('height', 'auto');

                    thisElContent.each(function(){
                      if (jQuery(this).actual('height') > minContentHeight && jQuery(this).actual('height') >= 0) {
                        minContentHeight = jQuery(this).actual('height');
                      }
                    });

                    jQuery(thisElContent).height(minContentHeight);
              }
          }


      });

    },
    init: function() {
      equalBoxes.resize_boxes();
    }
};

/* -- 1.38 LHS Menu - last active page -- */
var lhs_current = {

    set_last_active: function() {
        var active_elements = jQuery('.sidebar-left .inner-navigation').find('.active');
        var last_active = active_elements.length-1;
        active_elements.eq(last_active).addClass('current-page');
    },
    
    init: function() {
      lhs_current.set_last_active();
    }
};

/* -- 1.39 Save page floating -- */
var save_page_float = function() {
    if (!jQuery('.subtitle').length && !jQuery('.title').length && jQuery('.global-tab-saved').length) {
        jQuery('.global-tab-saved').addClass('no-float');
    }
};


/* -- 1.40 Carousel - equal height for navigation items  -- */
var carousel_navigation = function() {
  if (jQuery('.carousel-container').length > 0) {
    jQuery('.carousel-container').each(function(){
      var minContentHeight = 0;
      var minImageHeight = 9999;
      var carouselImageElements = jQuery(this).find('.carousel-navigation .slides li .multi-images');
      var carouselTextElements = jQuery(this).find('.carousel-navigation .slides li .carousel-navigation-bottom-text');


      jQuery(carouselImageElements).each(function(){
        jQuery(this).css('height', 'auto');
        if (jQuery(this).css('display') !== 'none') {
          if (jQuery(this).find('img').actual('height') < minImageHeight) {
            minImageHeight = jQuery(this).find('img').actual('height');
          }
        }
      });

      jQuery(carouselTextElements).each(function(){
        jQuery(this).css('height', 'auto');
          if (jQuery(this).actual('height') > minContentHeight) {
            minContentHeight = jQuery(this).actual('height');
          }
      });

      jQuery(carouselTextElements).height(minContentHeight);
      jQuery(carouselImageElements).height(minImageHeight);
    });
  }
};

/* -- 1.41 Multi-images blank img fix -- */
var multi_images_fix = function(that){
    jQuery('.multi-images').each(function(){
       var imgEl = jQuery(this).find('img');
       if (imgEl.attr('src').length === 0){ 
         jQuery(this).hide();
       }
    });
};

/* -- 1.42 Megamenu Loader - Ajax -- */
var megamenu_loader = function(){
    var siteId = jQuery('.site-id').attr('data-site-id');
    jQuery.ajax({ 
     url: GlobalVars.url.megamenu_elements+'?id='+siteId, 
     dataType: "html", 
     cache: true
     }).done(function(data) {
      jQuery('header .megamenu-position > .megamenu').html(data);

      if (jQuery('.site-navigation li').is('.active')) {
        var selected_value = jQuery('.site-navigation li.active a').attr('data-id');
        jQuery('header .megamenu-position').removeClass('mm-loader').find('.megamenu.wrap > ul').hide();
        jQuery('.megamenu.wrap').show().find("[data-id='"+selected_value+"']").show().addClass('mm-active');
      } else { 
        jQuery('header .megamenu-position').removeClass('mm-loader').find('.megamenu.wrap').hide();
      }
      custom.megamenu_columns();
    });

    var site_var_name = jQuery('span.site_class').attr('data-site-var');

    /*
    if (site_var_name === 'mauritius') {
      jQuery.ajax({ 
        url: "http://www.mdx.ac.uk/_resources/ajax/megamenu/mauritius", 
        dataType: "html", 
        cache: true
        }).done(function(data) {
        jQuery('.site_class').html(data);
      });
    }
    */
};








/*
 --------------------
 2. On window load
 --------------------
 */

jQuery(window).load(function(){ 
  equalBoxes.resize_boxes();
  hide_noResults.init();
  multi_images_fix();
  carousel_navigation();
  megamenu_loader();
});


/*
 --------------------
 3. On window resize
 --------------------
 */

jQuery(window).resize(function () {
   //  onResize.init();
   if (!jQuery('body').hasClass('profile')) {
     tabs.scrolling_tabs();
   }

   if (jQuery('body').hasClass('homepage')) {
       ResponsiveHome.init();
   }

   if (jQuery('.showcase_component').length > 0) {
    showcase_component.init();
    //equalBoxes.resize_boxes('.showcase_component');
    //equalizeComponentsImageHeight();
   }

   equalBoxes.resize_boxes();
   carousel_navigation();

});





/*
 --------------------
 4. Document ready
 --------------------
 */

jQuery(document).ready(function(){

    calendarPage.initialize();
    myUniHubLogin.init();
    lhs_current.init();
    pausePlayers();
    tabs.init();
    share_widget.init();
    announcement.init();
    cookies_notification.init();
    sticky_menu.init();
    saved_pages.init();
    mobile_navigation.init();
    showcase_component.init();
    promo_sliders.init();
    gallery_component.init(); 
    campaign_gallery_component.init(); 
    custom.init();
    rwd_image_maps.init();
    onResize.init();
    megamenu.init();
    form_inputs.init();

    main_search_ajax.init();
    related_results.init();
    az_results.init();
    az_letters.init();
    upcoming_events.init();
    search_page.init();

    sitewide_search_query_changer.check_page(); 
    calendar_setup.check_event_page();
    // add_gaps.width_check();
    mobile_share_button.mobile_only();
    border_color.check_width();
    map_campuses_toggle.init();
    ResponsiveHome.init(); // Positioning components on home page 
    ResponsiveCourse.init(); // Positioning components on course page

    wrap_list('.az-listing-results-box h5 + li');
    wrap_h5_with_list('.az-listing-results-box h5, .az-listing-results-box .ul-list');
    split_results_for_two_equal_columns('.az-listing-results-box div .ul-list');
    remove_other_resaults();

    //hide_noResults.init();
    comentErrorList();
    general_datepicker_setup.init();
    quoteBoxFloatHeight();
    leaveCommentFormActions();
    imageCaptionAlign();
    save_page_float();


    
});


/*
 --------------------
 5. Functions
 --------------------
 */


/* -- 5.1 Get Parameter -- */
function getParam(source, name) {
    name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
    var regexS = "[\\?&]"+name+"=([^&#]*)";
    var regex = new RegExp( regexS );
    var results = regex.exec( source );
    if( results === null ) {
        return null;
    }
    else {
        return results[1];
    }
}

/* -- 5.2 Tabs scrolling -- */
function scroll_forward(){
    var widthToScroll = jQuery('.tabbed-navigation').outerWidth() || 500;
    widthToScroll = '+=' + widthToScroll;
    jQuery('.tabbed-menu-scroll').removeClass('backClicked').addClass('forwardClicked');
    jQuery('.tabbed-menu-scroll').animate({scrollLeft: widthToScroll}, 'slow', function() {
        if (jQuery('.tabbed-menu-scroll').hasClass('forwardClicked')) {
            scroll_forward();
        }
}); }
function scroll_back(){
    var widthToScroll = jQuery('.tabbed-navigation').outerWidth() || 500;
    widthToScroll = '-=' + widthToScroll;
    jQuery('.tabbed-menu-scroll').removeClass('forwardClicked').addClass('backClicked');
    jQuery('.tabbed-menu-scroll').animate({scrollLeft: widthToScroll}, 'slow', function() {
        if (jQuery('.tabbed-menu-scroll').hasClass('backClicked')) {
            scroll_back();
        }
}); }
function stopScrolling(){
    jQuery('.tabbed-menu-scroll').stop(true).removeClass("forwardClicked").removeClass("backClicked");
}



/* -- 5.3 Pagination - Listings -- */
function Pagination(container, pages){
  if ( jQuery(container).length ) {

    var nearPages = parseInt(pages) - 1;  
    var selector = jQuery(container).find('.page-list a');
    var total = selector.length;
    var page = parseInt(jQuery(container).find('.page-list a.current').text());

    var dots = "<a class=\'dots\'>...</a>";

    if(page == 1){
      jQuery(container).find('.prev').css({"opacity":"0.5"}).find('a').removeAttr('href');
    }

    if(page == total){
      jQuery(container).find('.next').css({"opacity":"0.5"}).find('a').removeAttr('href');
    }
    
    if(total > parseInt(pages) * 2 + 1){ // cut 
      if((page > nearPages + 2) && (page <= total-nearPages - 2)){ // front & back
        // front
        for(var i = 1 ; i < page-nearPages ; i++){
          jQuery(selector[i]).remove();
        }
        jQuery(".page-list a:first-child").after(dots);
        
        // back
        var start = page + nearPages;
        for(var j = start; j < total; j++){
          jQuery(selector[j-1]).remove();
        }
        jQuery(".page-list a:last-child").before(dots);
        
      }else if(page > nearPages + 2){ // front only
        
        var end = total - nearPages * 2 - 1;
        for(var i = 1 ; i < end ; i++){
          jQuery(selector[i]).remove();
        }
        jQuery(".page-list a:first-child").after(dots);
        
      }else if(page < total-nearPages){ // back only
        
        var start =  nearPages * 2 + 2;
        for(var j = start; j < total; j++){
          jQuery(selector[j-1]).remove();
        }
        jQuery(".page-list a:last-child").before(dots);
        
      }
    } // end cut
  }
} // end function


/* -- 5.4 AZ Columns -- */ 
/* A-Z Listing - wrap list */
function wrap_list(elements) {
      jQuery(elements).each(function(){
         jQuery(this).nextUntil('h5').andSelf().wrapAll('<div class="ul-list"/>');
       });
}

/* A-Z Listing - wrap h5 with list */
function wrap_h5_with_list(elements) {
      var divs = jQuery(elements);
      var h5;
      for(var i = 0; i < divs.length; i+=2) {
        h5  = jQuery(divs[i]).children('a').html();
        divs.slice(i, i+2).wrapAll("<div class='"+h5+"'></div>");
      }
}

/*A-Z Listing - split results for two equal columns */
function split_results_for_two_equal_columns(elements) {
    /*Function to check if number is integer*/
        function isInt(n) {
          return n % 1 === 0;
        }

    jQuery(elements).each(function(j,k){
         var $ul = $(this).addClass("left-column"), // Let original be first column
        $lis = $ul.children(), // Find all children `li` elements
        help_mid = $lis.length / 2;

        if (isInt(help_mid)) {
           mid_val = Math.floor(help_mid); // Calculate where to split 
        } else {
           mid_val = Math.floor(help_mid) + 1; // Calculate where to split
        }
        mid = mid_val,
        $newCol = $('<div />', {"class": "ul-list right-column"}).insertAfter($ul); // Create new column and add after original. "class" needs to be in quotes because it's a reserved keyword

        $lis.each(function(i) {
           i >= mid && $(this).appendTo($newCol); // Move `li` elements with index greater than middle
        });
    });
}

/*A-Z Listing - remove [Others] from list*/
function remove_other_resaults() {
       jQuery('a[href="#letter_@"]').parent().remove();
}


/* Tabs - button back to tabs scroll to tabs */
jQuery('.show-on-mobiles').click(function(event) {
  event.preventDefault();
  $(document.body).animate({
    'scrollTop':   $('#tabs-box').offset().top - 85
  }, 2000);
});


/* -- 5.5 Scroll to element -- */ 
function scrollToElement(selector, time, verticalOffset) {
    time = typeof(time) != 'undefined' ? time : 1000;
    verticalOffset = typeof(verticalOffset) != 'undefined' ? verticalOffset : 0;
    element = $(selector);
    offset = element.offset();
    offsetTop = offset.top + verticalOffset;
    $('html, body').animate({
        scrollTop: offsetTop
    }, time);
}

/*-- 2.8 equalize height of elements in 'I-want-blocks' and 'Find a professional' sections --*/
function equalizeComponentsImageHeight() {

var arrayOfAffectedElements = ['.content-container .showcase-item .showcase_area'],//list of selectors to process
    arrayLength = arrayOfAffectedElements.length;
minHeight = 99999,
    tmpObjectHandler = {};

for (var i = 0; i < arrayLength; i++) {
    if (jQuery(arrayOfAffectedElements[i]).length) {
        tmpObjectHandler = jQuery(arrayOfAffectedElements[i]);
        jQuery(tmpObjectHandler).each(function(){

            if (jQuery(this).find('img').length && jQuery(this).find('img').actual('height') < minHeight) {
                minHeight = jQuery(this).find('img').actual('height');
            }
        });
        jQuery(tmpObjectHandler).height(minHeight).css({'display': 'block', 'overflow': 'hidden'});
    }
}
}

/*-- 5.6 GTM + Youtube API -- Lightbox fix --*/
var gtmYoutubeApi = {
  variables: {
    player: "",
    timer: "",
    currentTime: 0,
    duration: 0,
    counter: 0,
    flag1stQ: true,
    flag2ndQ: true,
    flag3rdQ: true,
    flag4thQ: true,
    _label: "",
    _pageTitle: "",
    initialized: false
  },
  init: function() {
    //gtmYoutubeApi.removeScripts();
    jQuery('#cboxLoadedContent iframe').attr('id', 'player');
    if (!gtmYoutubeApi.variables.initialized) {
      var tag = document.createElement('script');
      tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
      gtmYoutubeApi.variables.initialized = true;

      window.onYouTubePlayerAPIReady = function() {
        gtmYoutubeApi.onYouTubeIframeAPIReady();
      }
      
    } else {
      gtmYoutubeApi.onYouTubeIframeAPIReady();
    }
    
  },
  ytPlayerInitialize: function(playerName) {
    gtmYoutubeApi.variables.player = new YT.Player(playerName, {
      events: {
        'onReady': gtmYoutubeApi.onPlayerReady,
        'onStateChange': gtmYoutubeApi.onPlayerStateChange,
        'onError': gtmYoutubeApi.onPlayerError
      }
    });
  },
  onYouTubeIframeAPIReady: function() {
    // lightbox fix -- store in onComplete method
    if (jQuery('#cboxLoadedContent iframe').length > 0) {
      gtmYoutubeApi.ytPlayerInitialize("player");
    }
    // flexslider fix -- store in after method
    if (jQuery('.flex-active-slide iframe').length > 0) {
      gtmYoutubeApi.ytPlayerInitialize("player_box");
    }
  },
  onPlayerReady: function(e) {
    gtmYoutubeApi.variables._label = e.target.getVideoData().title;
    gtmYoutubeApi.variables._pageTitle = document.title;
  },
  onPlayerStateChange: function(e) {
    gtmYoutubeApi.variables.currentTime = e.target.getCurrentTime();
    gtmYoutubeApi.variables.duration = e.target.getDuration();

    if (e.data === YT.PlayerState.PLAYING) {
      gtmYoutubeApi.variables._label = "Video Played - " + e.target.getVideoData().title;
      // push info while playing
      gtmYoutubeApi.gtmPush();
      // track played video (25%,50%,75%)
      gtmYoutubeApi.setTimer(gtmYoutubeApi.variables.currentTime, gtmYoutubeApi.variables.duration, e.target.getVideoData().title);

    } else if (e.data === YT.PlayerState.PAUSED) {
      // clear tracked video timer
      gtmYoutubeApi.clearTimer();

      gtmYoutubeApi.variables._label = "Video Paused - " + e.target.getVideoData().title;
      // push info while pausing
      gtmYoutubeApi.gtmPush();

    } else if (e.data === YT.PlayerState.ENDED) {
      // clear tracked video timer
      gtmYoutubeApi.clearTimer();

      gtmYoutubeApi.variables._label = "Video Ended - " + e.target.getVideoData().title;
      // push info while ended
      gtmYoutubeApi.gtmPush();

    }
  },
  removeScripts: function() {
    jQuery('head script').each(function() {
      if (jQuery(this).attr('src') === "https://www.youtube.com/iframe_api") {
        jQuery(this).remove();
      }
    });
    jQuery('#cboxLoadedContent iframe').attr('id', '');
    console.log('scripts removed');
  },
  /* methods: setTimer and clearTimer should be used in case of 25,50,75% video watched */
  setTimer: function(now, end, title) {
    gtmYoutubeApi.timer = setInterval(
      function() {
        if ((now > (end / 2 + end / 4)) && gtmYoutubeApi.variables.flag3rdQ) {
          gtmYoutubeApi.variables.flag3rdQ = false;
          gtmYoutubeApi.variables._label = "Video Played 75% reached - " + title;
          gtmYoutubeApi.gtmPush();
          // console.log('now: ' + now + ' | end*3/4: ' + end / 4 + end / 2);
        } else if ((now > end / 2) && gtmYoutubeApi.variables.flag2ndQ) {
          gtmYoutubeApi.variables.flag2ndQ = false;
          gtmYoutubeApi.variables._label = "Video Played 50% reached - " + title;
          gtmYoutubeApi.gtmPush();
          // console.log('now: ' + now + ' | end/2: ' + end / 2);
        } else if ((now > end / 4) && gtmYoutubeApi.variables.flag1stQ) {
          gtmYoutubeApi.variables.flag1stQ = false;
          gtmYoutubeApi.variables._label = "Video Played 25% reached - " + title;
          gtmYoutubeApi.gtmPush();
          // console.log('now: ' + now + ' | end/4: ' + end / 4);
        }
        now = now + 0.5;
      }, 500);
  },
  clearTimer: function() {
    clearInterval(gtmYoutubeApi.timer);
  },
  onPlayerError: function() {
    dataLayer.push({
      'event': 'error',
      'eventCategory': 'Youtube Videos',
      'eventAction': 'GTM',
      'eventLabel': "Youtube: " + e.target.getVideoUrl()
    });
  },
  gtmPush: function() {
    dataLayer.push({
      'event': 'youtube',
      'eventCategory': 'Youtube Videos',
      'eventAction': gtmYoutubeApi.variables._pageTitle,
      'eventLabel': gtmYoutubeApi.variables._label
    });
  },
  execute: function() {
    // check if GTM is set properly and the dataLayer array exists
    if (typeof dataLayer !== 'undefined' && dataLayer.length > 0) {
      gtmYoutubeApi.init();
    }
  }
};

/*-- 5.7 Calendar functionality --*/

/* --- CALENDAR OBJECT --- */

var calendarPage = {
    jsonEvents: {},
    events: [],
    results: [],
    calendarSelector: ".calendar-page .calendar-view",
    pastEventClass: "past-event",
    eventClass: "event",
    noEventsFound: "No events found on this day.",
    newDate: new Date(),
    currentDate: "",
    currentDateFormatted: "",
    ajaxUrl: "",
    monthNames: ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"],
    datesAndClasses: {},
    postInitialize: function() {
        // get events and set them a proper class
        calendarPage.pushEvents();

        jQuery('.event-by-day-container .ajax-loader').removeClass('show-loader');

        // initialize datepicker
        jQuery(calendarPage.calendarSelector).datepicker({
            firstDay: 1,
            dateFormat: 'dd/mm/yy',
            dayNamesMin: ['S', 'M', 'T', 'W', 'T', 'F', 'S'],
            beforeShowDay: function(date) {
                return [true, calendarPage.datesAndClasses[date.toString()] ? calendarPage.datesAndClasses[date.toString()] : ''];
            },
            onSelect: function(dateText, inst) {
                var currentDateFormatted = "" + calendarPage.minTwoDigits(inst.currentDay) + "/" + calendarPage.minTwoDigits(inst.currentMonth + 1) + "/" + inst.currentYear;
                calendarPage.updateResults(currentDateFormatted, inst.currentYear, calendarPage.minTwoDigits(inst.currentMonth + 1), calendarPage.minTwoDigits(inst.currentDay));
            }
        });

        // set minimal and maximum month you can navigate to
        calendarPage.setCalendarRange();

        // parse date for initial events listing
        calendarPage.currentDateFormatted = "" + calendarPage.minTwoDigits(calendarPage.newDate.getDate()) + "/" + calendarPage.minTwoDigits(calendarPage.newDate.getMonth() + 1) + "/" + calendarPage.newDate.getFullYear();

        // set initial events listing
        calendarPage.updateResults(calendarPage.currentDateFormatted, calendarPage.newDate.getFullYear(), calendarPage.minTwoDigits(calendarPage.newDate.getMonth() + 1), calendarPage.minTwoDigits(calendarPage.newDate.getDate()));
    },
    minTwoDigits: function(n) {
        return (n < 10 ? '0' : '') + n;
    },
    initialize: function() {
        if (jQuery('.calendar-page').length > 0) {

            calendarPage.ajaxUrl = jQuery('input[name="calendar-json"]').val();

            jQuery('.event-by-day-container').append('<div class="ajax-loader show-loader"></div>');

            jQuery.ajax({
                url: calendarPage.ajaxUrl,
                contentType: "application/json",
                dataType: "json"
            }).done(function(data) {
                calendarPage.jsonEvents = data;
                calendarPage.postInitialize();
            });
        }
    },
    pushEvents: function() {
        var allDates = [],
            fullDate, fullDateInt, datesAndClasses;
        calendarPage.currentDate = parseInt("" + calendarPage.newDate.getFullYear() + calendarPage.minTwoDigits(calendarPage.newDate.getMonth() + 1) + calendarPage.minTwoDigits(calendarPage.newDate.getDate()));

        for (var i = 0; i < calendarPage.jsonEvents.results.result.length; i++) {

            allDates = calendarPage.jsonEvents.results.result[i].event_all_dates.split('|');

            for (var u = 0; u < allDates.length; u++) {
                fullDate = allDates[u].split('/');
                fullDateInt = parseInt("" + fullDate[2] + fullDate[1] + fullDate[0]);


                if (fullDateInt >= calendarPage.currentDate) {
                    calendarPage.events.push(fullDate[2] + '/' + fullDate[1] + '/' + fullDate[0] + '?' + calendarPage.eventClass);
                } else {
                    calendarPage.events.push(fullDate[2] + '/' + fullDate[1] + '/' + fullDate[0] + '?' + calendarPage.eventClass + " " + calendarPage.pastEventClass);
                }

                fullDate = [];

            }

            allDates = [];

        }

        for (var i = 0; i < calendarPage.events.length; i++) {
            datesAndClasses = calendarPage.events[i].split('?');

            calendarPage.datesAndClasses[new Date(datesAndClasses[0]).toString()] = datesAndClasses[1];
        }

    },
    updateResults: function(currentDate, year, month, day) {
        var allDates = [],
            fullDate, fullDateInt;

        jQuery('.calendar-results').find('.event-item').remove();
        jQuery('.event-by-day-container .ajax-loader').addClass('show-loader');

        for (var i = 0; i < calendarPage.jsonEvents.results.result.length; i++) {

            allDates = calendarPage.jsonEvents.results.result[i].event_all_dates.split('|');

            for (var u = 0; u < allDates.length; u++) {
                fullDate = allDates[u].split('/');
                fullDateInt = parseInt("" + fullDate[2] + fullDate[1] + fullDate[0]);

                if (allDates[u] === currentDate) {
                    calendarPage.results.push(calendarPage.jsonEvents.results.result[i]);
                    fullDate = [];
                    break;
                }

                fullDate = [];

            }

            allDates = [];

        }

        if (calendarPage.results.length === 0) {
            jQuery('.calendar-results').append('<div class="event-item no-results"><p>' + calendarPage.noEventsFound + '</p></div>');
        }

        var truncateString = function(someString) {
            var _result = someString;
            var _resultArray = _result.split(" ");
            if (_resultArray.length > 20) {
                _resultArray = _resultArray.slice(0, 20);
                _result = _resultArray.join(" ") + "...";
            }
            return _result;
        };

        for (var i = 0; i < calendarPage.results.length; i++) {
            if (calendarPage.results[i].thumb) {
                jQuery('.calendar-results').append('<div class="event-item"><a href="' + calendarPage.results[i].url + '"><div class="event-image"><img src="' + calendarPage.results[i].thumb + '" alt="' + calendarPage.results[i].thumbnail_alt + '" /></div><h5> ' + calendarPage.results[i].title + ' </h5><p>' + truncateString(calendarPage.results[i].description) + '</p><time class="event-item-date"> ' + day + ' ' + calendarPage.monthNames[parseInt(month) - 1] + ' ' + year + ', ' + calendarPage.results[i].start_time + ' </time></a></div>');
            } else {
                jQuery('.calendar-results').append('<div class="event-item"><a href="' + calendarPage.results[i].url + '"><h5> ' + calendarPage.results[i].title + ' </h5><p>' + truncateString(calendarPage.results[i].description) + '</p><time class="event-item-date"> ' + day + ' ' + calendarPage.monthNames[parseInt(month) - 1] + ' ' + year + ', ' + calendarPage.results[i].start_time + ' </time></a></div>');
            }
        }

        jQuery('.event-by-day-container .ajax-loader').removeClass('show-loader');

        calendarPage.results = [];
    },
    setCalendarRange: function() {
        var tempDateMin, tempDateMax, minYear = "2099",
            minMonth = "12",
            minDay = "31",
            maxYear = "2000",
            maxMonth = "01",
            maxDay = "01",
            tempDateMinString, tempDateMaxString, currentDateString;

        for (var i = 0; i < calendarPage.jsonEvents.results.result.length; i++) {
            tempDateMin = calendarPage.jsonEvents.results.result[i].start_date.split('/');
            tempDateMax = calendarPage.jsonEvents.results.result[i].end_date.split('/');

            if (parseInt("" + tempDateMin[2] + tempDateMin[1] + tempDateMin[0]) < parseInt(minYear + minMonth + minDay)) {
                minYear = tempDateMin[2];
                minMonth = tempDateMin[1];
                minDay = tempDateMin[0];
            }
            if (parseInt("" + tempDateMax[2] + tempDateMax[1] + tempDateMax[0]) > parseInt(maxYear + maxMonth + maxDay)) {
                maxYear = tempDateMax[2];
                maxMonth = tempDateMax[1];
                maxDay = tempDateMax[0];
            }
        }

        if (calendarPage.jsonEvents.results.result.length === 0) {
            minYear = calendarPage.newDate.getFullYear();
            maxYear = minYear;
            minMonth = calendarPage.newDate.getMonth();
            maxMonth = minMonth;
            minDay = calendarPage.newDate.getDate();
            maxDay = minDay;
        }

        currentDateString = "" + calendarPage.newDate.getFullYear() + calendarPage.minTwoDigits(calendarPage.newDate.getMonth()) + calendarPage.minTwoDigits(calendarPage.newDate.getDate());
        tempDateMinString = "" + minYear + minMonth + minDay;
        tempDateMaxString = "" + maxYear + maxMonth + maxDay;


        if (parseInt(currentDateString) < parseInt(tempDateMinString)) {
            $(calendarPage.calendarSelector).datepicker('option', 'minDate', new Date(parseInt(calendarPage.newDate.getFullYear()), parseInt(calendarPage.minTwoDigits(calendarPage.newDate.getMonth())), parseInt(calendarPage.minTwoDigits(calendarPage.newDate.getDate())), 0, 0, 0));
        } else {
            $(calendarPage.calendarSelector).datepicker('option', 'minDate', new Date(parseInt(minYear), parseInt(minMonth)-1, parseInt(minDay), 0, 0, 0));
        }

        if (parseInt(currentDateString) > parseInt(tempDateMaxString)) {
            $(calendarPage.calendarSelector).datepicker('option', 'maxDate', new Date(parseInt(calendarPage.newDate.getFullYear()), parseInt(calendarPage.minTwoDigits(calendarPage.newDate.getMonth()))-1, parseInt(calendarPage.minTwoDigits(calendarPage.newDate.getDate())), 0, 0, 0));
        } else {
            $(calendarPage.calendarSelector).datepicker('option', 'maxDate', new Date(parseInt(maxYear), parseInt(maxMonth)-1, parseInt(maxDay), 0, 0, 0));
        }
        
    }
};

/*-- 5.8 MyUniHub Login --*/

var myUniHubLogin = {
    createCookie: function() {
        var actualDate = new Date();
        actualDate.setDate(actualDate.getDate() + 100);
        document.cookie = 'MDX_MUSIC_REDIRECTION=Redirected; expires=' + actualDate + '; path=/; domain=.mdx.ac.uk';
    },
    readCookie: function(name) {
        var nameEQ = name + "=";
        var ca = document.cookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) == ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    },
    eraseCookie: function(name) {
        document.cookie = name + '=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=.mdx.ac.uk';
    },
    init: function() {
        if (jQuery('.homepage.unihub-site').length > 0) {
            if (myUniHubLogin.readCookie('MDX_MUSIC_LOGIN')) {
                if (!myUniHubLogin.readCookie('MDX_MUSIC_REDIRECTION')) {
                    myUniHubLogin.createCookie();
                    // UNCOMMENT IF OPEN MYUNIHUB IN NEW WINDOW
                    // var win = window.open('https://myunihub.mdx.ac.uk/', '_blank');
                    // win.focus();
                }
            } else {
                if (myUniHubLogin.readCookie('MDX_MUSIC_REDIRECTION')) {
                    myUniHubLogin.eraseCookie('MDX_MUSIC_REDIRECTION');
                }
            }

            jQuery(".logout").on("click", function() {
                myUniHubLogin.eraseCookie('MDX_MUSIC_LOGIN');
            });
        }
    }
};
